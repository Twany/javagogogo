<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lottery | Java GoGoGo</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/favicon.ico">
    <script src="https://hm.baidu.com/hm.js?xxxxxxxxxxx"></script>
    <meta name="description" content="个人的一份笔记小结">
    <meta name="robots" content="all">
    <meta name="author" content="Twany">
    <meta name="keywords" content="Java 全栈知识体系, java体系, java知识体系, java框架,java详解,java学习路线,java spring, java面试, 知识体系, java技术体系, java编程, java编程指南,java开发体系, java开发,java教程,java,java数据结构, 算法, 开发基础">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.9a84d516.css" as="style"><link rel="preload" href="/assets/js/app.8f462fc4.js" as="script"><link rel="preload" href="/assets/js/2.7c7aaa4f.js" as="script"><link rel="preload" href="/assets/js/32.01010e94.js" as="script"><link rel="prefetch" href="/assets/js/10.90c029b8.js"><link rel="prefetch" href="/assets/js/11.a8513089.js"><link rel="prefetch" href="/assets/js/12.45793064.js"><link rel="prefetch" href="/assets/js/13.afedc45b.js"><link rel="prefetch" href="/assets/js/14.b575fb2e.js"><link rel="prefetch" href="/assets/js/15.d4dfa320.js"><link rel="prefetch" href="/assets/js/16.d2a2c776.js"><link rel="prefetch" href="/assets/js/17.c78b960a.js"><link rel="prefetch" href="/assets/js/18.b4e39f44.js"><link rel="prefetch" href="/assets/js/19.4c473d30.js"><link rel="prefetch" href="/assets/js/20.c3e13e72.js"><link rel="prefetch" href="/assets/js/21.112f64bc.js"><link rel="prefetch" href="/assets/js/22.5cda56a8.js"><link rel="prefetch" href="/assets/js/23.a4e64f5d.js"><link rel="prefetch" href="/assets/js/24.e9c345e9.js"><link rel="prefetch" href="/assets/js/25.e2b46852.js"><link rel="prefetch" href="/assets/js/26.7efd898e.js"><link rel="prefetch" href="/assets/js/27.aa914d50.js"><link rel="prefetch" href="/assets/js/28.ded27504.js"><link rel="prefetch" href="/assets/js/29.ae219ced.js"><link rel="prefetch" href="/assets/js/3.7fbf0d76.js"><link rel="prefetch" href="/assets/js/30.fa8a4866.js"><link rel="prefetch" href="/assets/js/31.7830eb12.js"><link rel="prefetch" href="/assets/js/33.ccf83441.js"><link rel="prefetch" href="/assets/js/4.c03742da.js"><link rel="prefetch" href="/assets/js/5.a3df2be0.js"><link rel="prefetch" href="/assets/js/6.cf19b855.js"><link rel="prefetch" href="/assets/js/7.58468a9d.js"><link rel="prefetch" href="/assets/js/8.67d10431.js"><link rel="prefetch" href="/assets/js/9.54f3a4d5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9a84d516.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Java GoGoGo</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/java/basic/java-basic.html" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/md/project/yxdt.html" class="nav-link">
  项目
</a></div><div class="nav-item"><a href="/md/prepare/cv.html" class="nav-link">
  面试准备
</a></div><div class="nav-item"><a href="/md/about/me/about-me.html" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/md/java/basic/java-basic.html" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/md/project/yxdt.html" class="nav-link">
  项目
</a></div><div class="nav-item"><a href="/md/prepare/cv.html" class="nav-link">
  面试准备
</a></div><div class="nav-item"><a href="/md/about/me/about-me.html" class="nav-link">
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>项目</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/project/yxdt.html" class="sidebar-link">易寻地图</a></li><li><a href="/md/project/lottery.html" aria-current="page" class="active sidebar-link">Lottery</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/project/lottery.html#lottery" class="sidebar-link">Lottery</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#零、前置知识" class="sidebar-link">零、前置知识</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#一、全局处理" class="sidebar-link">一、全局处理</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#总体架构" class="sidebar-link">总体架构</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#数据库设计" class="sidebar-link">数据库设计</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#三、dubbo-的-rpc-调用-广播模式" class="sidebar-link">三、Dubbo 的 RPC 调用：广播模式</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#四、抽奖活动策略表设计" class="sidebar-link">四、抽奖活动策略表设计</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#五、抽奖策略领域模块开发" class="sidebar-link">五、抽奖策略领域模块开发</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#六、模板模式-处理抽奖流程" class="sidebar-link">六、模板模式：处理抽奖流程</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#七、简单工厂模式-搭建发奖领域" class="sidebar-link">七、简单工厂模式：搭建发奖领域</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#八、状态模式-活动领域的配置" class="sidebar-link">八、状态模式：活动领域的配置</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#九、id-生成策略·领域开发" class="sidebar-link">九、ID 生成策略·领域开发</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十、自研分库分表中间件" class="sidebar-link">十、自研分库分表中间件</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十一、「编程式事务」领取活动领域开发" class="sidebar-link">十一、「编程式事务」领取活动领域开发</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十二、在应用层编排抽奖过程" class="sidebar-link">十二、在应用层编排抽奖过程</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十三、组合模式-规则引擎量化人群参与活动" class="sidebar-link">十三、组合模式：规则引擎量化人群参与活动</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十四、防腐层-门面接口封装和对象转换" class="sidebar-link">十四、防腐层：门面接口封装和对象转换</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十五、搭建-mq-kafka-环境" class="sidebar-link">十五、搭建 MQ + kafka 环境</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十六、使用-mq-解耦抽奖、发货流程" class="sidebar-link">十六、使用 MQ 解耦抽奖、发货流程</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十七、引入xxl-job处理活动状态扫描" class="sidebar-link">十七、引入xxl-job处理活动状态扫描</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十八、扫描库表补偿发货单-mq-消息" class="sidebar-link">十八、扫描库表补偿发货单 MQ 消息</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#十九、设计滑动库存分布式锁处理活动秒杀-防止超卖" class="sidebar-link">十九、设计滑动库存分布式锁处理活动秒杀：防止超卖</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#个人优化" class="sidebar-link">个人优化</a></li><li class="sidebar-sub-header"><a href="/md/project/lottery.html#末、完整的流程" class="sidebar-link">末、完整的流程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="lottery"><a href="#lottery" class="header-anchor">#</a> Lottery</h2> <h4 id="已经给出了代码了-不重写-但是要补充类似的功能-这样才不会纸上谈兵"><a href="#已经给出了代码了-不重写-但是要补充类似的功能-这样才不会纸上谈兵" class="header-anchor">#</a> 已经给出了代码了，不重写，但是要补充类似的功能，这样才不会纸上谈兵</h4> <blockquote><p>专门做一个面试章节，把难记的知识点都转换成业务：（想起一个就加一个）</p> <ul><li>线程池的原理与使用：官方给的 &amp; 自定义的都写一个</li></ul> <p><a href="https://wx.zsxq.com/mweb/views/topicdetail/topicdetail.html?topic_id=584111424885424&amp;inviter_id=48524228242588&amp;share_from=ShareToWechat&amp;keyword=0aAblb2oc" target="_blank" rel="noopener noreferrer">https://wx.zsxq.com/mweb/views/topicdetail/topicdetail.html?topic_id=584111424885424&amp;inviter_id=48524228242588&amp;share_from=ShareToWechat&amp;keyword=0aAblb2oc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
分布式并发：<a href="https://wx.zsxq.com/mweb/views/topicdetail/topicdetail.html?topic_id=181548424212822&amp;inviter_id=48524228242588&amp;share_from=ShareToWechat&amp;keyword=0bGynl1Ap" target="_blank" rel="noopener noreferrer">https://wx.zsxq.com/mweb/views/topicdetail/topicdetail.html?topic_id=181548424212822&amp;inviter_id=48524228242588&amp;share_from=ShareToWechat&amp;keyword=0bGynl1Ap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> &gt; <a href="https://tech.meituan.com/2017/12/22/ddd-in-practice.html" target="_blank" rel="noopener noreferrer">https://tech.meituan.com/2017/12/22/ddd-in-practice.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ⭐️⭐️⭐️⭐️⭐️</p></blockquote> <p>Lottery 相关简历 ⭐️⭐️⭐️
<img src="https://raw.githubusercontent.com/Twany/picGoStore/master/image%20(2).png" alt=""> <img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1675863569592-719ce5bb-064a-4009-89f6-ca95efef70d2.png" alt="image.png"> <a name="PHuVO"></a></p> <h2 id="零、前置知识"><a href="#零、前置知识" class="header-anchor">#</a> 零、前置知识</h2> <p><a name="PP4BN"></a></p> <h3 id="ddd-介绍"><a href="#ddd-介绍" class="header-anchor">#</a> DDD 介绍</h3> <p><a name="AhCMB"></a></p> <h3 id="_1-概念讲解"><a href="#_1-概念讲解" class="header-anchor">#</a> 1. 概念讲解</h3> <p>DDD，domain drive design</p> <ul><li>普通的 MVC，有 DAO 层，如 Student，里面只有属性的 getter,setter，这叫做「<strong>贫血模型</strong>」（<em>如果问 DDD 和 MVC 的区别，这个要答出来是核心</em>）</li> <li>充血模型：把实体的操作都封装到里面</li></ul> <p>比如有一个 Student 的领域，一个 Course 的领域，领域内模型是充血的，其各自是独立的，那么如果想要交互呢，那么就在上面抽象出一个「领域服务」进行两个领域的交互，这两个领域可以独立发展</p> <ul><li><strong><em>领域可以独立发展，只要领域服务足够稳定</em></strong></li> <li>域是相对独立的业务层</li> <li>仓库 Resposity 用于领域的存储，只是存储用</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/300264/1671524306031-1ebcb4a5-53ab-4385-b567-fd7fba544cdd.jpeg" alt=""><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1671524604780-34582428-39d2-4051-9b9c-366080c8d2c8.png" alt="image.png"></p> <ul><li>防腐层：比如数据存储，并不只是 MySQL，在数据存储上又抽象出防腐层：到时候可以更改数据库为其他的，而底层的数据存储不用变
<a name="NgIEK"></a></li></ul> <h3 id="rpc"><a href="#rpc" class="header-anchor">#</a> RPC</h3> <ul><li>提供者提供 RPC 接口，然后打包</li> <li>消费者导入这个 RPC 包，去调用这个服务</li> <li>本质上相当于提供者提供了一个快照，消费者去调用这个快照，刚好消费者这些快照内容都在，就成功调用了
<ul><li>如果消费者更改了内容，和之前打包的内容不同，那就出现问题了</li></ul></li></ul> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1671357838259-0221154e-360f-41eb-b669-7910904484bd.png" alt="image.png"></p> <blockquote><p>RPC 底层通信是 Netty，Socket 通信</p></blockquote> <p><a name="POv6T"></a></p> <h3 id="设计模式"><a href="#设计模式" class="header-anchor">#</a> 设计模式</h3> <p>美团的这篇设计模式涉及到本文多个：
<a name="ULtSG"></a></p> <h2 id="一、全局处理"><a href="#一、全局处理" class="header-anchor">#</a> 一、全局处理</h2> <p><a name="f1RzK"></a></p> <h3 id="请求响应码"><a href="#请求响应码" class="header-anchor">#</a> 请求响应码</h3> <blockquote><p>以一个枚举类的形式，封装在 Constant 类</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Constants</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ResponseCode</span> <span class="token punctuation">{</span>
        <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token string">&quot;0000&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">UN_ERROR</span><span class="token punctuation">(</span><span class="token string">&quot;0001&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;未知失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">ILLEGAL_PARAMETER</span><span class="token punctuation">(</span><span class="token string">&quot;0002&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;非法参数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">INDEX_DUP</span><span class="token punctuation">(</span><span class="token string">&quot;0003&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;主键冲突&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> info<span class="token punctuation">;</span>

        <span class="token class-name">ResponseCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> code<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> info<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><blockquote><p>还要很多</p></blockquote> <p><a name="GNhXe"></a></p> <h3 id="请求响应结果"><a href="#请求响应结果" class="header-anchor">#</a> 请求响应结果</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3826891916021780628L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> info<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Result</span> <span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Result</span> <span class="token function">buildSuccessResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Result</span> <span class="token function">buildErrorResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 省略 getter  setter</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><a name="z1Vee"></a></p> <h4 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <p><a name="JzKbw"></a></p> <h2 id="总体架构"><a href="#总体架构" class="header-anchor">#</a> 总体架构</h2> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672746838141-98227e63-477f-4601-b9e0-bb220839a957.png" alt="2-03.png"> <a name="vJI6S"></a></p> <h3 id="防腐层如何体现"><a href="#防腐层如何体现" class="header-anchor">#</a> 防腐层如何体现？</h3> <p>即<code>lottery-interface</code> 防腐体现在：对 DTO 进行处理，然后执行抽奖过程，然后返回结果，就是对<code>lottery-application</code>的一层浅封装</p> <blockquote><p>返回的结果是 VO，在 Vue 显示的结果</p></blockquote> <p><a name="Z43zs"></a></p> <h3 id="单独模块结构"><a href="#单独模块结构" class="header-anchor">#</a> 单独模块结构</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672747123652-53e32187-e859-4829-9e38-473f150d39a9.png" alt="5-02.png"></p> <hr> <p><a name="Vb2dr"></a></p> <h2 id="数据库设计"><a href="#数据库设计" class="header-anchor">#</a> 数据库设计</h2> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672746883959-6382b235-26df-48f4-bf79-4559c49d0eb4.png" alt="4-01.png"></p> <p><code>**user_take_activity**</code><strong>是用户参与了活动就插入一条记录</strong><br><strong>但是参与了不一定中奖，并且如果中奖了也是之后才发送</strong><br><strong>所以</strong><code>**user_strategt_export_xxx**</code><strong>记录用户的中奖记录</strong></p> <hr> <p><a name="yNlM6"></a></p> <h2 id="三、dubbo-的-rpc-调用-广播模式"><a href="#三、dubbo-的-rpc-调用-广播模式" class="header-anchor">#</a> 三、Dubbo 的 RPC 调用：广播模式</h2> <p><a name="lzYf2"></a></p> <h3 id="server-端"><a href="#server-端" class="header-anchor">#</a> Server 端</h3> <ul><li><code>**@Service**</code><strong>是 Dubbo 的注解，加上了就是要暴露出的 RPC 接口</strong> <ul><li><code>import org.apache.dubbo.config.annotation.Service;</code></li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityBooth</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityBooth</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IActivityDao</span> activityDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ActivityRes</span> <span class="token function">queryActivityById</span><span class="token punctuation">(</span><span class="token class-name">ActivityReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Activity</span> activity <span class="token operator">=</span> activityDao<span class="token punctuation">.</span><span class="token function">queryActivityById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ActivityDto</span> activityDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityDto<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActivityRes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>## <span class="token class-name">Dubbo</span> 广播方式配置
dubbo<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> <span class="token class-name">Lottery</span>
    version<span class="token operator">:</span> <span class="token number">1.0</span><span class="token number">.0</span>
  registry<span class="token operator">:</span>
    address<span class="token operator">:</span> multicast<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">224.5</span><span class="token number">.6</span><span class="token number">.7</span><span class="token operator">:</span><span class="token number">1234</span>		<span class="token comment">// 广播模式</span>
  protocol<span class="token operator">:</span>
    name<span class="token operator">:</span> dubbo
    port<span class="token operator">:</span> <span class="token number">20880</span>
  scan<span class="token operator">:</span>
    base<span class="token operator">-</span>packages<span class="token operator">:</span> cn<span class="token punctuation">.</span>itedus<span class="token punctuation">.</span>lottery<span class="token punctuation">.</span>rpc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><a name="HxSd7"></a></p> <h3 id="client-调用端"><a href="#client-调用端" class="header-anchor">#</a> Client 调用端</h3> <ol><li>先导入 Server 端的依赖（需要在 Server 端先 install 打包）</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>cn<span class="token punctuation">.</span>itedus<span class="token punctuation">.</span>lottery<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>lottery<span class="token operator">-</span>rpc<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>使用</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 导入的都是Server端暴露出的</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itedus<span class="token punctuation">.</span>lottery<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span></span><span class="token class-name">IActivityBooth</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itedus<span class="token punctuation">.</span>lottery<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>req<span class="token punctuation">.</span></span><span class="token class-name">ActivityReq</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itedus<span class="token punctuation">.</span>lottery<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>res<span class="token punctuation">.</span></span><span class="token class-name">ActivityRes</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Reference</span><span class="token punctuation">(</span>interfaceClass <span class="token operator">=</span> <span class="token class-name">IActivityBooth</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">&quot;dubbo://127.0.0.1:20880&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">IActivityBooth</span> activityBooth<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_rpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ActivityReq</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span><span class="token number">927L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ActivityRes</span> result <span class="token operator">=</span> activityBooth<span class="token punctuation">.</span><span class="token function">queryActivityById</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;测试结果：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="3"><li>配置</li></ol> <blockquote><p>使用的是 Dubbo 的广播模式，N/A 是直连模式</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>## <span class="token class-name">Dubbo</span> 广播方式配置
dubbo<span class="token operator">:</span>
  application<span class="token operator">:</span>
    name<span class="token operator">:</span> <span class="token class-name">Lottery</span>
    version<span class="token operator">:</span> <span class="token number">1.0</span><span class="token number">.0</span>
  registry<span class="token operator">:</span>
    address<span class="token operator">:</span> multicast<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">224.5</span><span class="token number">.6</span><span class="token number">.7</span><span class="token operator">:</span><span class="token number">1234</span>
  protocol<span class="token operator">:</span>
    name<span class="token operator">:</span> dubbo
    port<span class="token operator">:</span> <span class="token number">20880</span>
  provider<span class="token operator">:</span>
    timeout<span class="token operator">:</span> <span class="token number">50000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><hr> <p><a name="UB4vZ"></a></p> <h2 id="四、抽奖活动策略表设计"><a href="#四、抽奖活动策略表设计" class="header-anchor">#</a> 四、抽奖活动策略表设计</h2> <hr> <p><a name="pgflF"></a></p> <h2 id="五、抽奖策略领域模块开发"><a href="#五、抽奖策略领域模块开发" class="header-anchor">#</a> 五、抽奖策略领域模块开发</h2> <p><strong>项目中所有的 map 都用</strong><code>**ConcurrentHashMap**</code><strong>存储保证线程安全</strong></p> <blockquote><p>分支：210814_xfg_strategy</p></blockquote> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1671865151318-dd67ccf8-395a-4f9b-95bf-693ffc265833.png" alt="image.png"></p> <ul><li>model 是用到的一些 dto</li> <li>repository 是数据库的一些数据查询</li> <li>service 下的 algorithm，是具体的抽奖算法，不依赖于任何数据，只是进行抽奖
<ul><li>传入抽奖策略 ID，返回奖品 ID</li></ul></li> <li>service 下的 draw，是对上面的抽奖算法的包装：传入请求参数，返回抽奖结果
<a name="qkr7m"></a></li></ul> <h3 id="_1-抽奖算法实现-总体概率"><a href="#_1-抽奖算法实现-总体概率" class="header-anchor">#</a> ① 抽奖算法实现：总体概率</h3> <ul><li>必中</li></ul> <p>如果 A 奖品抽空后，B 和 C 奖品的概率按照 3:5 均分，相当于 B 奖品中奖概率由 0.3 升为 0.375</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 新的概率 = 原概率 ÷ 新的概率和（结果向上取整）</span>
<span class="token keyword">int</span> rateVal <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>differenceDenominator<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_UP</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>即一般的话所有奖品总概率加起来是 1，但如果不是 1 的话，那么也会按照已有的概率总和进行等比例划分</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">randomDraw</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> excludeAwardIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">BigDecimal</span> differenceDenominator <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>

    <span class="token comment">// 排除掉不在抽奖范围的奖品ID集合</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AwardRateInfo</span><span class="token punctuation">&gt;</span></span> differenceAwardRateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AwardRateInfo</span><span class="token punctuation">&gt;</span></span> awardRateIntervalValList <span class="token operator">=</span> awardRateInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AwardRateInfo</span> awardRateInfo <span class="token operator">:</span> awardRateIntervalValList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> awardId <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>excludeAwardIds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>awardId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        differenceAwardRateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>awardRateInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加入到概念总和，重新计算剔除后的概率值</span>
        differenceDenominator <span class="token operator">=</span> differenceDenominator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 前置判断，如果筛选完后的列表只有0个或1个奖品，直接返回（就是100%）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>differenceAwardRateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>differenceAwardRateList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> differenceAwardRateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取随机概率值</span>
    <span class="token class-name">SecureRandom</span> secureRandom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> randomVal <span class="token operator">=</span> secureRandom<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 循环获取奖品</span>
    <span class="token class-name">String</span> awardId <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cursorVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AwardRateInfo</span> awardRateInfo <span class="token operator">:</span> differenceAwardRateList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新的概率 = 原概率 ÷ 新的概率和（结果向上取整）</span>
        <span class="token keyword">int</span> rateVal <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>differenceDenominator<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_UP</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>randomVal <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>cursorVal <span class="token operator">+</span> rateVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            awardId <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cursorVal <span class="token operator">+=</span> rateVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回中奖结果</span>
    <span class="token keyword">return</span> awardId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><a name="qKXeB"></a></p> <h3 id="_1-抽奖算法实现-单项概率"><a href="#_1-抽奖算法实现-单项概率" class="header-anchor">#</a> ① 抽奖算法实现：单项概率</h3> <ul><li>如果总奖品概率和不为 1 的话，可能不中奖。有两种不中奖的情况
<ul><li>一种是排除了一部分奖项，如把 4，5 等奖排除，那么就可能不中奖，即原来随机到 4，5 等奖的改为未中奖</li> <li>二是原来的奖品总概率之和就不为 1，这个原理要去看<code>rateTuple[]</code>的初始化已经抽奖时的随机
<a name="Bwpg5"></a></li></ul></li></ul> <h4 id="_1-进行-ratetuple-的初始化"><a href="#_1-进行-ratetuple-的初始化" class="header-anchor">#</a> 1. 进行 rateTuple[]的初始化</h4> <blockquote><p>注意，初始化数组方法需要用<code>synchronize</code>修饰，防止多次初始化</p></blockquote> <ul><li>将策略 Id 和概率数组绑定起来</li> <li><strong>设置一个浮标，用来填充不同的概率，如果概率总和为 1，那么加起来就循环 100 次</strong></li> <li>首先要从总的中奖列表中排除掉那些被排除掉的奖品，这些奖品会涉及到概率的值重新计算。</li> <li>如果排除后剩下的奖品列表小于等于 1，则可以直接返回对应信息</li> <li>接下来就使用随机数工具生产一个 100 内的随值与奖品列表中的值进行循环比对，算法时间复杂度<code>**O(n)**</code> <ul><li>使用<code>SecureRandom</code>生成随机数，seed 是一个<code>AtomicLong</code>：<code>this.seed = new AtomicLong();</code> <ul><li><code>SecureRandom</code>128 位加密位数更多更安全</li> <li>seed 是从 OS 上的随机种子，更难猜到</li> <li><strong>seed 是线程安全的</strong></li></ul></li> <li><strong>一个概率值就是一个循环的节点，如 0.2，就是循环到 20</strong></li> <li><strong>数组内填充的是</strong><code>**奖品ID**</code></li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 斐波那契散列增量，逻辑：黄金分割点：(√5 - 1) / 2 = 0.6180339887，Math.pow(2, 32) * 0.6180339887 = 0x61c88647
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 数组初始化长度 128，保证数据填充时不发生碰撞的最小初始化值
 * 为什么是18，这就是HashMap为什么是2的幂次方，因为最后 hashcode &amp; n-1  ，散列更均匀 ⭐️⭐️⭐️⭐️⭐️
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RATE_TUPLE_LENGTH</span> <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 存放概率与奖品对应的散列结果，strategyId -&gt; rateTuple
	// 注意这里用 ConcurrentHashMap 去存放 ⭐️⭐️⭐️⭐️⭐️
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> rateTupleMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 奖品区间概率值，strategyId -&gt; [awardId-&gt;begin、awardId-&gt;end]
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AwardRateVO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> awardRateInfoMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initRateTuple</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AwardRateInfo</span><span class="token punctuation">&gt;</span></span> awardRateInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存奖品概率信息</span>
    awardRateInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">,</span> awardRateInfoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// RATE_TUPLE_LENGTH：128</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rateTuple <span class="token operator">=</span> rateTupleMap<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token constant">RATE_TUPLE_LENGTH</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> cursorVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AwardRateInfo</span> awardRateInfo <span class="token operator">:</span> awardRateInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里使用 BigDecimal</span>
        <span class="token keyword">int</span> rateVal <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 循环填充概率范围值</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> cursorVal <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>rateVal <span class="token operator">+</span> cursorVal<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rateTuple<span class="token punctuation">[</span><span class="token function">hashIdx</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> awardRateInfo<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        cursorVal <span class="token operator">+=</span> rateVal<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 斐波那契（Fibonacci）散列法，计算哈希索引下标值
 *
》
 * @param val 值
 * @return 索引
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">hashIdx</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> hashCode <span class="token operator">=</span> val <span class="token operator">*</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">+</span> <span class="token constant">HASH_INCREMENT</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token constant">RATE_TUPLE_LENGTH</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 例：11111 &amp; 10  -&gt; 11</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p><a name="cjCv1"></a></p> <h4 id="_2-单项抽奖"><a href="#_2-单项抽奖" class="header-anchor">#</a> 2. 单项抽奖</h4> <ul><li><p>获取策略对应的元组</p></li> <li><p>随机出一个索引</p></li> <li><p>用这个索引 <code>hashIdx(randomVal)</code>去获得<code>rateTuple</code>对应位置的奖项，时间复杂度<code>O(1)</code></p> <p>⭐️⭐️⭐️<br>随机出的索引一定是[1,100]中的一个；<br>如果所有的奖项概率和为 1，那么 rateTuple 一定是由[1,100]逐个去 hashIdx 后填充的，索引一定会获得奖品<br>但是如果所有的奖项概率和不为 1，比如为 0.6。那么 rateTuple 则是由[1,60]逐个 hashIdx 后填充的，如果随机索引超过 60，则很可能为 null</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">randomDraw</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> excludeAwardIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 获取策略对应的元祖</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rateTuple <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span>rateTupleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> rateTuple <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 随机索引</span>
    <span class="token keyword">int</span> randomVal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">hashIdx</span><span class="token punctuation">(</span>randomVal<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回结果</span>
    <span class="token class-name">String</span> awardId <span class="token operator">=</span> rateTuple<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>excludeAwardIds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>awardId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;未中奖&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">//  如果 awardId是null的情况，因为rateTuple并不是一定会填满，randomId可能会随机到一个不存在的位置上</span>
    <span class="token comment">// ⭐️️️️⭐️️️️⭐️️️️⭐️️️️⭐️️️️</span>
    <span class="token comment">//  rateTuple[]如果所有的奖品概率加起来是1的话，那么就是从1-100都随机了一次，randomVal的idx一定会落到这个数组上非null的位置</span>
    <span class="token comment">//  但是，如果所有奖品概率加起来不为1，那么只能随机到[1, xx]，那么randomVal是可以随机到[1,100]的，就可能落在null上了</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>awardId<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;未中奖&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> awardId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><a name="QZs75"></a></p> <h3 id="斐波那契散列"><a href="#斐波那契散列" class="header-anchor">#</a> 斐波那契散列</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_idx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储idx出现次数</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1. 黄金分割点：(√5 - 1) / 2 = 0.6180339887</span>
    <span class="token comment">// 2. 1.618:1 == 1:0.618</span>
    <span class="token comment">// 3. Math.pow(2, 32) * 0.6180339887 = 0x61c88647</span>
    <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hashCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hashCode <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">+</span> <span class="token constant">HASH_INCREMENT</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> hashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 都是花活</span>
        map<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;斐波那契散列：&quot;</span> <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token string">&quot; 普通散列：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map2<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打印idx出现次数</span>
    <span class="token comment">// 1就是出现1次，2就是出现了两次</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 普通散列碰撞几率更大</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>斐波那契散列碰撞几率更小<br><img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1672574026490-9833152c-ac1a-4b41-8279-c85d8b53d8d3.png#averageHue=%23f9f5f2&amp;clientId=ucc857adb-eb09-4&amp;from=paste&amp;height=2916&amp;id=u0b8b6706&amp;name=image.png&amp;originHeight=5832&amp;originWidth=1359&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=904229&amp;status=done&amp;style=stroke&amp;taskId=ud877b24e-aad3-4411-8f71-527c97119bc&amp;title=&amp;width=679.5" alt="image.png"><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1676791523825-7d462661-1da7-45f4-b855-57032a96d1ed.png" alt="image.png">弄清楚各层的意义 ⭐️⭐️⭐️
<a name="VfFpv"></a></p> <h3 id="策略模式的体现"><a href="#策略模式的体现" class="header-anchor">#</a> 策略模式的体现</h3> <p>整体概率抽奖、单体抽奖都继承了<code>BaseAlgorithm</code>，他们都加了<code>@Component</code>注解，然后在一个配置类<code>DrawConfig</code>中，注入到一个 Map</p> <blockquote><p>用户只需要传入抽奖策略名称，即可选择哪一项，这就是策略模式</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DrawConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IDrawAlgorithm</span> entiretyRateRandomDrawAlgorithm<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IDrawAlgorithm</span> singleRateRandomDrawAlgorithm<span class="token punctuation">;</span>

    <span class="token comment">/** 抽奖策略组 */</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">IDrawAlgorithm</span><span class="token punctuation">&gt;</span></span> drawAlgorithmGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        drawAlgorithmGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>StrategyMode</span><span class="token punctuation">.</span><span class="token constant">ENTIRETY</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entiretyRateRandomDrawAlgorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        drawAlgorithmGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>StrategyMode</span><span class="token punctuation">.</span><span class="token constant">SINGLE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> singleRateRandomDrawAlgorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>使用<code>@PostConstruct</code>在 Bean 注入后进行初始化</p></blockquote> <p><a name="YJXwU"></a></p> <h3 id="模板模式的体现"><a href="#模板模式的体现" class="header-anchor">#</a> 模板模式的体现</h3> <p>抽奖过程，就是一个模板模式<br>模板模式的核心：一个抽象 abstract 类，定义了一个过程，其中一些过程调用本类的抽象方法，子类只用实现这些抽象方法，主方法就是按照这个去调用了<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1678366981463-9d9b9ae6-da7c-4123-a4a9-9b1e8dfb74a5.png" alt="image.png" title="注意这个过程"></p> <ol><li>获取抽奖策略对应的奖品</li> <li><code>initTruple[]</code>初始到内存（只是单体概率需要）</li> <li>获取不在抽奖列表的奖品</li> <li>执行抽奖</li> <li>包装结果</li></ol> <hr> <p><a name="AmjfV"></a></p> <h2 id="六、模板模式-处理抽奖流程"><a href="#六、模板模式-处理抽奖流程" class="header-anchor">#</a> 六、模板模式：处理抽奖流程</h2> <blockquote><p>使用模板方法设计模式优化类 DrawExecImpl 抽奖过程方法实现，主要以<strong>抽象类</strong> AbstractDrawBase 编排定义流程，定义抽象方法由类 DrawExecImpl 做具体实现的方式进行处理</p></blockquote> <p>抽奖模式就是按照一个模板定义了，然后子类都按照这个流程去做。本章节最大的目标在于把抽奖流程标准化，需要考虑的一条思路线包括：</p> <ol><li>根据入参策略 ID 获取抽奖策略配置</li> <li>校验和处理抽奖策略的数据初始化到内存</li> <li><strong>获取那些被排除掉的抽奖列表，这些奖品可能是已经奖品库存为空，或者因为风控策略不能给这个用户薅羊毛的奖品</strong> <ol><li><strong>整体抽奖会排除，然后再计算全体的概率</strong></li> <li><strong>单体抽奖 如何抽取到了直接返回 null</strong></li></ol></li> <li><strong>执行抽奖算法</strong></li> <li>包装中奖结果</li></ol> <blockquote><p><strong>注意：只是 3、4 需要重写（有多种方式</strong></p></blockquote> <p><a name="jy2sr"></a></p> <h3 id="_0-定义模板接口idrawexec"><a href="#_0-定义模板接口idrawexec" class="header-anchor">#</a> 0.定义模板接口<code>IDrawExec</code></h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDrawExec</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 抽奖方法
     * @param req 抽奖参数；用户ID、策略ID
     * @return    中奖结果
     */</span>
    <span class="token class-name">DrawResult</span> <span class="token function">doDrawExec</span><span class="token punctuation">(</span><span class="token class-name">DrawReq</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><a name="t7Tpv"></a></p> <h3 id="_1-定义抽象模板过程类abstractdrawbase"><a href="#_1-定义抽象模板过程类abstractdrawbase" class="header-anchor">#</a> 1. 定义抽象模板过程类<code>AbstractDrawBase</code></h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// DrawStrategySupport提供数据DAO的支持，IDrawExec是只有一个doDrawExec方法的接口</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractDrawBase</span> <span class="token keyword">extends</span> <span class="token class-name">DrawStrategySupport</span> <span class="token keyword">implements</span> <span class="token class-name">IDrawExec</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DrawResult</span> <span class="token function">doDrawExec</span><span class="token punctuation">(</span><span class="token class-name">DrawReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取抽奖策略</span>
        <span class="token class-name">StrategyRich</span> strategyRich <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">queryStrategyRich</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Strategy</span> strategy <span class="token operator">=</span> strategyRich<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 校验抽奖策略是否已经初始化到内存</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkAndInitRateData</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strategy<span class="token punctuation">.</span><span class="token function">getStrategyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strategyRich<span class="token punctuation">.</span><span class="token function">getStrategyDetailList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 获取不在抽奖范围内的列表，包括：奖品库存为空、风控策略、临时调整等</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> excludeAwardIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryExcludeAwardIds</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 执行抽奖算法</span>
        <span class="token class-name">String</span> awardId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawAlgorithm</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAlgorithmGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strategy<span class="token punctuation">.</span><span class="token function">getStrategyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> excludeAwardIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 包装中奖结果</span>
        <span class="token keyword">return</span> <span class="token function">buildDrawResult</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> awardId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取不在抽奖范围内的列表，包括：奖品库存为空、风控策略、临时调整等，这类数据是含有业务逻辑的，所以需要由具体的实现方决定</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryExcludeAwardIds</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 执行抽奖算法</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">drawAlgorithm</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">IDrawAlgorithm</span> drawAlgorithm<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> excludeAwardIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 校验抽奖策略是否已经初始化到内存</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkAndInitRateData</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> strategyMode<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StrategyDetail</span><span class="token punctuation">&gt;</span></span> strategyDetailList<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 包装抽奖结果</span>
    <span class="token keyword">private</span> <span class="token class-name">DrawResult</span> <span class="token function">buildDrawResult</span><span class="token punctuation">(</span><span class="token class-name">String</span> uId<span class="token punctuation">,</span> <span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">String</span> awardId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawResult</span><span class="token punctuation">(</span>uId<span class="token punctuation">,</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>DrawState</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAwardInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>在上面可以看到，模板类提供了 5 个步骤</p> <ol><li>获取抽奖策略
<ol><li>调用父类 DrawStrategySupport 获得数据</li></ol></li> <li>检验抽奖策略是否已经初始化
<ol><li>调用本类<code>checkAndInitRateData()</code>，这个方法是<code>private</code>，子类不可以重写</li></ol></li> <li>获取需要排除掉的列表
<ol><li><strong>调用本类</strong><code>**_queryExcludeAwardIds()_**</code><strong>，是</strong><code>**protected**</code><strong>，子类可以重写</strong></li> <li><strong>这个就是模板模式的体现了</strong></li></ol></li> <li>执行抽奖算法
<ol><li><strong>调用本类</strong><code>**_drawAlgorithm()_**</code><strong>，是</strong><code>**protected**</code><strong>，子类可以重写</strong></li></ol></li> <li>返回结果
<ol><li>调用本类<code>buildDrawResult()</code>，是 private，子类不可重写</li></ol></li></ol> <p>这 5 个步骤都调用了本类的方法，如果想要提供模板过程就把方法暴露出去（protected），由子类重写</p> <p><strong><em>之所以定义这 2 个抽象方法，是因为这 2 个方法可能随着实现方有不同的方式变化，不适合定义成通用的方法。</em></strong></p> <p><a name="tUYbi"></a></p> <h3 id="_2-子类继承模板drawexecimpl"><a href="#_2-子类继承模板drawexecimpl" class="header-anchor">#</a> 2. 子类继承模板<code>DrawExecImpl</code></h3> <p><strong>类</strong><code>**DrawExecImpl**</code><strong>继承了模板类</strong><code>**AbstractDrawBase**</code><strong>，对其中的一些方法进行重写。这样，当调用模板时，执行的是模板类的流程，但是具体的方法则是执行的</strong><code>**DrawExecImpl**</code></p> <ul><li><strong>在</strong><code>drawAlgorithm</code>更新<code>activity_detail</code>库存 ⭐️⭐️⭐️</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 注入Spring容器</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;drawExec&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DrawExecImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractDrawBase</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DrawExecImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryExcludeAwardIds</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> awardList <span class="token operator">=</span> strategyRepository<span class="token punctuation">.</span><span class="token function">queryNoStockStrategyAwardList</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;执行抽奖策略 strategyId：{}，无库存排除奖品列表ID集合 awardList：{}&quot;</span><span class="token punctuation">,</span> strategyId<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>awardList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> awardList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">drawAlgorithm</span><span class="token punctuation">(</span><span class="token class-name">Long</span> strategyId<span class="token punctuation">,</span> <span class="token class-name">IDrawAlgorithm</span> drawAlgorithm<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> excludeAwardIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行抽奖，扣除`activity_detail`库存⭐️⭐️⭐️</span>
        <span class="token class-name">String</span> awardId <span class="token operator">=</span> drawAlgorithm<span class="token punctuation">.</span><span class="token function">randomDraw</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">,</span> excludeAwardIds<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断抽奖结果</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> awardId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * 扣减库存，暂时采用数据库行级锁的方式进行扣减库存，后续优化为 Redis 分布式锁扣减 decr/incr
         * 注意：通常数据库直接锁行记录的方式并不能支撑较大体量的并发，但此种方式需要了解，因为在分库分表下的正常数据流量下的个人数据记录中，是可以使用行级锁的，因为他只影响到自己的记录，不会影响到其他人
         */</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> strategyRepository<span class="token punctuation">.</span><span class="token function">deductStock</span><span class="token punctuation">(</span>strategyId<span class="token punctuation">,</span> awardId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 返回结果，库存扣减成功返回奖品ID，否则返回NULL 「在实际的业务场景中，如果中奖奖品库存为空，则会发送兜底奖品，比如各类券」</span>
        <span class="token keyword">return</span> isSuccess <span class="token operator">?</span> awardId <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>重写了<code>queryExcludeAwardIds()</code> <ul><li>后续可能添加进来一些其他的需要检验的项</li></ul></li> <li><code>drawAlgorithm()</code> <ul><li>后续可能需要将库存更新由 MySQL 更新为 Redis
<a name="lcaO1"></a></li></ul></li></ul> <h3 id="_3-使用模板类"><a href="#_3-使用模板类" class="header-anchor">#</a> 3. 使用模板类</h3> <ul><li>注入<code>DrawExecImpl</code>类，但是<strong>类型是模板接口类型</strong><code>**IDrawExec**</code></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// @Resource按名称注入，注入的是 DrawExecImpl 类：@Service(&quot;drawExec&quot;)</span>
<span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">IDrawExec</span> drawExec<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_drawExec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    drawExec<span class="token punctuation">.</span><span class="token function">doDrawExec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawReq</span><span class="token punctuation">(</span><span class="token string">&quot;小傅哥&quot;</span><span class="token punctuation">,</span> <span class="token number">10001L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>spring 去容器中找<code>IDrwaExec</code>类型的，注解名字为<code>drawExec</code>的 bean，找到了就将<code>DrawExecImpl</code>注入进来<br>然后调用<code>DrawExecImpl对象</code>的<code>doDrawExec()</code>，走的是模板类，然后具体的方式使用的是<code>DrawExecImpl</code>重写的方法<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672573750637-1d897c9f-d97f-4956-b3b4-2938fa96a987.png" alt="image.png"></p> <hr> <p><a name="g0BT6"></a></p> <h2 id="七、简单工厂模式-搭建发奖领域"><a href="#七、简单工厂模式-搭建发奖领域" class="header-anchor">#</a> 七、简单工厂模式：搭建发奖领域</h2> <p>工厂模式<a name="cvM0R"></a></p> <h3 id="_1-普通工厂"><a href="#_1-普通工厂" class="header-anchor">#</a> 1. 普通工厂</h3> <p>就是建立一个工厂类，对实现了同一接口的一些类进行实例的创建，用户传入对应的类 type，然后返回对应的</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Sender</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;mail&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MailSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;sms&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SmsSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;请输入正确的类型!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><a name="ocUTX"></a></p> <h3 id="_2-静态工厂"><a href="#_2-静态工厂" class="header-anchor">#</a> 2. 静态工厂</h3> <p>只有在调用时才去 new，直接调用对应的工厂方法<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1680436369011-2dba1344-163a-45d1-a370-bcd252c1fd1b.png" alt="image.png"> <a name="lqj48"></a></p> <h3 id="_3-工厂方法模式"><a href="#_3-工厂方法模式" class="header-anchor">#</a> 3. 工厂方法模式</h3> <p>通过依赖注入的思想，还是只有一个工厂接口，只不过最后多态到对应的对象</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* 抽象工厂
**/</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CoffeeFactory</span> <span class="token punctuation">{</span>
    <span class="token class-name">Coffee</span> <span class="token function">createCoffee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
* 具体工厂
*
* 抽象产品为coffee，具体产品为LatteCoffee和AmericanCoffee
* 这种工厂模式可以通过不同的具体工厂创建出不同的具体产品
**/</span>
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;LatteCoffeeFactory&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LatteCoffeeFactory</span> <span class="token keyword">implements</span> <span class="token class-name">CoffeeFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Coffee</span> <span class="token function">createCoffee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LatteCoffee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;AmericanCoffeeFactory&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AmericanCoffeeFactory</span> <span class="token keyword">implements</span> <span class="token class-name">CoffeeFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Coffee</span> <span class="token function">createCoffee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AmericanCoffee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><a name="fn1Li"></a></p> <h3 id="_3-抽象工厂模式"><a href="#_3-抽象工厂模式" class="header-anchor">#</a> 3. 抽象工厂模式</h3> <p>简单工厂&amp;静态工厂两者不符合开闭原则，即如果要创建新的工厂还需要再去改动<br>抽象工厂是在工厂上又出一个接口，每个商品都有自己的工厂类去实现这个接口</p> <blockquote><p><strong>即想要啥工厂，就创建啥商品的工厂</strong></p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 工厂接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Provider</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Sender</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 对应工厂类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMailFactory</span> <span class="token keyword">implements</span> <span class="token class-name">Provider</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Sender</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MailSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendSmsFactory</span> <span class="token keyword">implements</span> <span class="token class-name">Provider</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Sender</span> <span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SmsSender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Provider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMailFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Sender</span> sender <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token namespace">sender<span class="token punctuation">.</span></span>Send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>本项目中是一个简单工厂：传入常量，返回对应的对象类</p> <blockquote><p>需求：抽奖得到奖品，奖品类型不同：优惠券、兑换码、实物等，每一个都有各自的处理，所以**<em>使用工厂模式来发放对应的奖品</em>**</p> <ul><li>介绍：定义一个创建对象的接口，让其子类自己决定实例化哪一个工厂类，<strong>工厂模式使其创建过程延迟到子类进行</strong>。</li> <li>和策略模式一样，也是利用一个 Map 将各种奖品的 Bean 都放进去，用户传入奖品代码即返回对应奖品的对象，由其本身去执行发奖</li></ul></blockquote> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672387371184-12b95ad9-7412-4cb2-8544-5a941997937b.png" alt="image.png"> <a name="i5HZV"></a></p> <h3 id="_1-项目结构"><a href="#_1-项目结构" class="header-anchor">#</a> 1. 项目结构</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672387751421-b80504a6-23fe-439a-8a74-b38148e7e75a.png" alt="image.png"> <a name="n2O0L"></a></p> <h3 id="_2-执行流程"><a href="#_2-执行流程" class="header-anchor">#</a> 2. 执行流程</h3> <p>先执行之前的抽奖算法<code>drawExec()</code>获得具体的商品，然后将商品类型传入工厂，返回具体的商品类，由<strong>商品类进行抽奖</strong><br><strong>发送了奖品就更新</strong><code>**user_stragety_export**</code><strong>的发奖状态</strong><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672389541990-a31e6893-c7a9-44d4-b561-48a6b81e2bdc.jpeg" alt=""> <a name="Z14FE"></a></p> <h3 id="_3-uml-类图"><a href="#_3-uml-类图" class="header-anchor">#</a> 3. UML 类图</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672390954837-0d38e9a8-1c4d-4387-9a2c-983b5abd34e5.jpeg" alt=""> <a name="aCtrA"></a></p> <h3 id="_2-测试使用"><a href="#_2-测试使用" class="header-anchor">#</a> 2. 测试使用</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_award</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行抽奖</span>
    <span class="token class-name">DrawResult</span> drawResult <span class="token operator">=</span> drawExec<span class="token punctuation">.</span><span class="token function">doDrawExec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawReq</span><span class="token punctuation">(</span><span class="token string">&quot;小傅哥&quot;</span><span class="token punctuation">,</span> <span class="token number">10001L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断抽奖结果</span>
    <span class="token class-name">Integer</span> drawState <span class="token operator">=</span> drawResult<span class="token punctuation">.</span><span class="token function">getDrawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>DrawState</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>drawState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;未中奖 DrawAwardInfo is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 封装发奖参数，orderId：2109313442431 为模拟ID，需要在用户参与领奖活动时生成</span>
    <span class="token class-name">DrawAwardInfo</span> drawAwardInfo <span class="token operator">=</span> drawResult<span class="token punctuation">.</span><span class="token function">getDrawAwardInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">GoodsReq</span> goodsReq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GoodsReq</span><span class="token punctuation">(</span>drawResult<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;2109313442431&quot;</span><span class="token punctuation">,</span> drawAwardInfo<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAwardInfo<span class="token punctuation">.</span><span class="token function">getAwardName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAwardInfo<span class="token punctuation">.</span><span class="token function">getAwardContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 awardType 从抽奖工厂中获取对应的发奖服务</span>
    <span class="token class-name">IDistributionGoods</span> distributionGoodsService <span class="token operator">=</span> distributionGoodsFactory<span class="token punctuation">.</span><span class="token function">getDistributionGoodsService</span><span class="token punctuation">(</span>drawAwardInfo<span class="token punctuation">.</span><span class="token function">getAwardType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DistributionRes</span> distributionRes <span class="token operator">=</span> distributionGoodsService<span class="token punctuation">.</span><span class="token function">doDistribution</span><span class="token punctuation">(</span>goodsReq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;测试结果：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>distributionRes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><blockquote><p><strong>在具体的商品类中，发放了商品还要将抽奖记录存入数据库，这部分后期做</strong></p></blockquote> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672573787438-b470ff7f-163c-4003-a33e-80b8847e7749.png" alt="image.png"></p> <hr> <p><a name="amriW"></a></p> <h2 id="八、状态模式-活动领域的配置"><a href="#八、状态模式-活动领域的配置" class="header-anchor">#</a> 八、状态模式：活动领域的配置</h2> <p>这一页主要搞清楚数据存储 &amp; DAO 层操作<br>所有的领域 domain 存储都用的相同的数据存储架构<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677046689572-5f73a637-24af-4cc7-9243-cf7d28a09d29.png" alt="image.png"></p> <ul><li>所有的对数据库的本质上的操作都是在<code>lottery-infrastructure</code></li> <li>领域类的封装都是在<code>lotter-domain</code> <ul><li>domain 内有一个个的领域，每一个领域内对数据库的操作都封装在<code>repository</code>内，即是一些对业务的服务</li> <li>比如<code>cn.itedus.lottery.domain.activity.repository</code>下就是对于<code>activity</code>的数据仓储服务接口封装<code>IActivityRepository</code></li> <li>这个<code>IActivityRepository</code>只是一个接口，真正的实现要交给<code>lottery.infrastructure.repository</code>的具体实现类，实现这个接口</li></ul></li> <li>对于<code>lottery-infrastructure</code>有三个文件夹：
<ul><li><code>dao</code>：负责对数据库的本质上的操作，由它来写（Mapper 映射 mybatis.xml）</li> <li><code>po</code>：数据库实体类</li> <li><code>repository</code>：每一个<code>domain</code>下的<code>repository</code>接口的具体实现类都在此</li></ul></li></ul> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672407845513-1f72b4b9-3842-4295-88da-2d04fe0d91fa.png" alt="image.png"> <a name="N671l"></a></p> <h3 id="状态模式"><a href="#状态模式" class="header-anchor">#</a> 状态模式</h3> <blockquote></blockquote> <p><strong>有什么状态：未提交、待审核、审核通过、进行中、关闭</strong></p> <p><strong>功能：用类来写的自动状态机，通过判断前置状态以限制状态流转</strong><br><strong>具体地，用 <strong><code>**Abstractstate**</code></strong> 定义状态，每个子类单独控制状态之间的流转许可，</strong><code>**IStateHandler**</code>** 提供具体状态流转的操作服务**</p> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672571243562-43a2ff07-ecfa-4d5f-adff-5117642ff4bc.png" alt="image.png"><br>活动的状态有上述多种：</p> <ol><li>定义一个基类<code>AbstractState</code>，内部有状态流转的方法</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractState</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">protected</span> <span class="token class-name">IActivityRepository</span> activityRepository<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 活动提审
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">arraignment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核通过
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">checkPass</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核拒绝
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">checkRefuse</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 撤审撤销
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">checkRevoke</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 活动关闭
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 活动开启
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 活动执行
     *
     * @param activityId   活动ID
     * @param currentState 当前状态
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">doing</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><ol start="2"><li>对于每一种具体的状态都给其封装成一个 Java Bean，继承自<code>AbstractState</code>，实现其方法，以活动关闭状态<code>CloseState</code>为例
<ol><li><strong><em>在这些方法中所有的入参都是一样的，</em></strong><code>**_activityId_**</code><strong><em>(活动 ID)、</em></strong><code>**_currentStatus_**</code><strong><em>(当前状态)，只有他们的具体实现是不同的（根据状态来的）。</em></strong></li></ol></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CloseState</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractState</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">arraignment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;活动关闭不可提审&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">checkPass</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;活动关闭不可审核通过&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">checkRefuse</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;活动关闭不可审核拒绝&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">checkRevoke</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;活动关闭不可撤销审核&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;活动关闭不可重复关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> activityRepository<span class="token punctuation">.</span><span class="token function">alterStatus</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentState<span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> isSuccess <span class="token operator">?</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">,</span> <span class="token string">&quot;活动开启完成&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildErrorResult</span><span class="token punctuation">(</span><span class="token string">&quot;活动状态变更失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doing</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;活动关闭不可变更活动中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><ol start="3"><li>然后将这七个状态封装进一个配置类（注入）</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateConfig</span> <span class="token punctuation">{</span>
	<span class="token comment">// 注入</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ArraignmentState</span> arraignmentState<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CloseState</span> closeState<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DoingState</span> doingState<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">EditingState</span> editingState<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OpenState</span> openState<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PassState</span> passState<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RefuseState</span> refuseState<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Enum</span><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">AbstractState</span><span class="token punctuation">&gt;</span></span> stateGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">ARRAIGNMENT</span><span class="token punctuation">,</span> arraignmentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">CLOSE</span><span class="token punctuation">,</span> closeState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">DOING</span><span class="token punctuation">,</span> doingState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">EDIT</span><span class="token punctuation">,</span> editingState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">,</span> openState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">PASS</span><span class="token punctuation">,</span> passState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stateGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">REFUSE</span><span class="token punctuation">,</span> refuseState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="4"><li>对外暴露出状态处理接口<code>IStateHandler</code></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IStateHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 提审
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token function">arraignment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核通过
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token function">checkPass</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 审核拒绝
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token function">checkRefuse</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 撤销审核
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token function">checkRevoke</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 关闭
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 开启
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 运行活动中
     * @param activityId    活动ID
     * @param currentStatus 当前状态
     * @return              审核结果
     */</span>
    <span class="token class-name">Result</span> <span class="token function">doing</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><ol start="5"><li>定义一个具体的状态处理类，调用状态处理方法（内部就是根据状态来调用对应的方法）</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateHandlerImpl</span> <span class="token keyword">extends</span> <span class="token class-name">StateConfig</span> <span class="token keyword">implements</span> <span class="token class-name">IStateHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">arraignment</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arraignment</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">checkPass</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkPass</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">checkRefuse</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkRefuse</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">checkRevoke</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkRevoke</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doing</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Enum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">&gt;</span></span> currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stateGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doing</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> currentStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><blockquote><p>这里用到<code>extends StateConfig</code>，其实也可以换为内部类使用：<code>new StateConfig().get(currentStatus)</code></p></blockquote> <p><strong><em>根据传入的状态码来调用对应的状态类</em></strong></p> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672573095969-06df33b5-ec2b-4931-b9c3-aa14ac94c5c7.png" alt="image.png" title="图左是活动的创建；图右是应用了状态模式的状态变更"><br><strong>因为活动创建有多步，采用</strong><code>**@Transactional(rollbackFor = Exception.class)**</code><strong>作为事务控制（这个不用分库分表，所以不用使用 DBRouter 的事务机制）</strong></p> <ul><li>添加活动</li> <li>添加奖品</li> <li>添加对应策略</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityConfigReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;创建活动配置开始，activityId：{}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ActivityConfigRich</span> activityConfigRich <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getActivityConfigRich</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加活动配置</span>
        <span class="token class-name">ActivityVO</span> activity <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityRepository<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加奖品配置</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AwardVO</span><span class="token punctuation">&gt;</span></span> awardList <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getAwardList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityRepository<span class="token punctuation">.</span><span class="token function">addAward</span><span class="token punctuation">(</span>awardList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加策略配置</span>
        <span class="token class-name">StrategyVO</span> strategy <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityRepository<span class="token punctuation">.</span><span class="token function">addStrategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加策略明细配置</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StrategyDetailVO</span><span class="token punctuation">&gt;</span></span> strategyDetailList <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStrategyDetailList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityRepository<span class="token punctuation">.</span><span class="token function">addStrategyDetailList</span><span class="token punctuation">(</span>strategyDetailList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;创建活动配置完成，activityId：{}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;创建活动配置失败，唯一索引冲突 activityId：{} reqJson：{}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><hr> <p><a name="OcPRx"></a></p> <h2 id="九、id-生成策略·领域开发"><a href="#九、id-生成策略·领域开发" class="header-anchor">#</a> 九、ID 生成策略·领域开发</h2> <p><a name="HSgw3"></a></p> <h3 id="_1-configuration-bean"><a href="#_1-configuration-bean" class="header-anchor">#</a> 1. @Configuration + @Bean</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672579504379-dc5ac13f-6f58-47b9-a284-0cfd65aebb13.png" alt="image.png"> <a name="IokoC"></a></p> <h3 id="_2-三种-id-生成策略"><a href="#_2-三种-id-生成策略" class="header-anchor">#</a> 2. 三种 ID 生成策略</h3> <p><strong>这三种都加上</strong><code>**synchronized**</code></p> <p>在 domain 领域包下新增支撑领域，ID 的生成服务就放到这个领域下实现。<br>关于 ID 的生成因为有三种不同 ID 用于在不同的场景下；</p> <ul><li><p>订单号：唯一、大量、订单创建时使用、分库分表</p></li> <li><p>活动号：唯一、少量、活动创建时使用、单库单表</p></li> <li><p>策略号：唯一、少量、活动创建时使用、单库单表</p> <p>策略模式，是因为外部的调用方会需要根据不同的场景来选择出适合的 ID 生成策略，而策略模式就非常适合这一场景的使用，有三种 ID 生成策略<br>三种 ID 生成策略都**<em>需要实现一个</em><strong><code>**_IIdGenerator_**</code></strong><em>，用于实现多态</em>**</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IIdGenerator</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 获取ID，目前有两种实现方式
     * 1. 雪花算法，用于生成单号
     * 2. 日期算法，用于生成活动编号类，特性是生成数字串较短，但指定时间内不能生成太多
     * 3. 随机算法，用于生成策略ID
     *
     * @return ID
     */</span>
    <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><a name="OtKBd"></a></p> <h4 id="_1-randomnumeric纯随机数-随机-id-生成器-用-lang3-中的工具实现"><a href="#_1-randomnumeric纯随机数-随机-id-生成器-用-lang3-中的工具实现" class="header-anchor">#</a> ① <code>RandomNumeric</code>纯随机数，随机 Id 生成器，用 lang3 中的工具实现</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomNumeric</span> <span class="token keyword">implements</span> <span class="token class-name">IIdGenerator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomNumeric</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><a name="g2ARp"></a></p> <h4 id="_2-日期算法-打乱排序-2020-年为准-小时-周期-日-三位随机数"><a href="#_2-日期算法-打乱排序-2020-年为准-小时-周期-日-三位随机数" class="header-anchor">#</a> ② 日期算法，打乱排序：2020 年为准 + 小时 + 周期 + 日 + 三位随机数</h4> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672580467901-c77ab043-39b6-4a19-b9b6-0d3c00d965c1.png" alt="image.png"></p> <blockquote><p>年月日小时要打乱顺序，为什么？防止黑客直接拼接，即更安全
<code>String.format(&quot;%03d&quot;, new Random().nextInt(1000))</code>：让字符串固定位，即这个数有可能是一位或者 2 位，那么给他固定成三位（0 补齐）</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShortCode</span> <span class="token keyword">implements</span> <span class="token class-name">IIdGenerator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> year <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">YEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> week <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">WEEK_OF_YEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> day <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">DAY_OF_WEEK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hour <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">HOUR_OF_DAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打乱排序：2020年为准 + 小时 + 周期 + 日 + 三位随机数</span>
        <span class="token class-name">StringBuilder</span> idStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        idStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>year <span class="token operator">-</span> <span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        idStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>hour<span class="token punctuation">)</span><span class="token punctuation">;</span>
        idStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%02d&quot;</span><span class="token punctuation">,</span> week<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        idStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">;</span>
        idStr<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%03d&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>idStr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><a name="P2QRw"></a></p> <h4 id="_3-雪花算法"><a href="#_3-雪花算法" class="header-anchor">#</a> ③ 雪花算法</h4> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672580488651-aac75f2f-4b5b-44fd-aa4f-ac8bb8a45a0a.png" alt="image.png"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowFlake</span> <span class="token keyword">implements</span> <span class="token class-name">IIdGenerator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Snowflake</span> snowflake<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>	<span class="token comment">// 注意这里先构造好了，即采用配置的方式先初始化了 ⭐️⭐️⭐️</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 0 ~ 31 位，可以采用配置的方式使用</span>
        <span class="token keyword">long</span> workerId<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            workerId <span class="token operator">=</span> <span class="token class-name">NetUtil</span><span class="token punctuation">.</span><span class="token function">ipv4ToLong</span><span class="token punctuation">(</span><span class="token class-name">NetUtil</span><span class="token punctuation">.</span><span class="token function">getLocalhostStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            workerId <span class="token operator">=</span> <span class="token class-name">NetUtil</span><span class="token punctuation">.</span><span class="token function">getLocalhostStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// IP右移16位，然后取低5位（31变为二进制就是11111）</span>
        workerId <span class="token operator">=</span> workerId <span class="token operator">&gt;&gt;</span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> dataCenterId <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        snowflake <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">createSnowflake</span><span class="token punctuation">(</span>workerId<span class="token punctuation">,</span> dataCenterId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 注意是synchronized的⭐️⭐️⭐️</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 12位，自增序列号，一共2^12-1=4096，即一毫秒内可以生成4096个自增序列</span>
        <span class="token keyword">return</span> snowflake<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><a name="aCaxW"></a></p> <h3 id="_3-策略模式"><a href="#_3-策略模式" class="header-anchor">#</a> 3. 策略模式</h3> <ol><li><strong><em>用@Configuration、@Bean 的方式</em></strong>，将<strong>缓存三种策略的 hashMap 直接注册到了 IOC 容器里</strong>。
<ol><li>三种策略都是加了<code>@Component</code>，在方法内（作为<code>idGeanarator()</code>的参数传入）需要用到时 Spring 会去容器找的</li></ol></li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1672580980647-c33047de-d686-4277-b6c6-5fe222cca0b9.png#averageHue=%23eaf1e7&amp;clientId=ucc857adb-eb09-4&amp;from=paste&amp;height=399&amp;id=vhMh7&amp;name=image.png&amp;originHeight=1438&amp;originWidth=2020&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=1679362&amp;status=done&amp;style=none&amp;taskId=uddfa6fad-9988-4209-9208-e323bda1e81&amp;title=&amp;width=560" alt="image.png"><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672580849619-b4ae5e90-1410-42a8-b34b-5230db9c5255.png" alt="image.png" title="默认是单例的，更改的话要加上@Scope"></p> <ol start="2"><li>第五章也用了策略模式，方式不太一样，它在 <code>**DrawConfig**</code>** 类里定义了**<code>**hashMap**</code><strong>字段来缓存抽奖策略，通过继承类（</strong><code>**static**</code><strong>）的方式从 hashMap 里取出具体策略使用</strong></li></ol> <p>本章使用的策略模式，感觉更简洁更解耦！<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672580937677-9b67e0c0-9614-4630-91fb-5261a9d1a2ae.png" alt="image.png" title="测试使用"></p> <p><strong>像这种直接从 Spring 容器取，传入的都是之前写好的常量</strong></p> <hr> <p><a name="iW5nD"></a></p> <h2 id="十、自研分库分表中间件"><a href="#十、自研分库分表中间件" class="header-anchor">#</a> 十、自研分库分表中间件</h2> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1681026455585-3d45631f-7846-433f-a0f0-05b789af612e.png" alt="image.png"> <a name="AQfv8"></a></p> <h3 id="如何将配置文件读取到内存"><a href="#如何将配置文件读取到内存" class="header-anchor">#</a> 如何将配置文件读取到内存</h3> <ul><li>配置文件写着分表数分库数，需要先读取进来配置到一个 Map 中</li> <li><strong>实现</strong><code>**EnvironmentAware**</code><strong>接口，重写</strong><code>**setEnvironment(Environment environment****)**</code><strong>，在 Spring 启动时即可读取配置文件值</strong></li> <li><strong>这个配置文件是在 lottery 工程，因为 DBRouter 只是作为一个 starter 导入进来</strong></li> <li><strong>将配置文件的多个数据库配置读取进来，然后挨个构建 spring 的 jdbc 的管理器</strong></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>mini<span class="token operator">-</span>db<span class="token operator">-</span>router<span class="token operator">:</span>
  jdbc<span class="token operator">:</span>
    datasource<span class="token operator">:</span>
      dbCount<span class="token operator">:</span> <span class="token number">2</span>
      tbCount<span class="token operator">:</span> <span class="token number">4</span>
      <span class="token keyword">default</span><span class="token operator">:</span> db00
      routerKey<span class="token operator">:</span> uId
      list<span class="token operator">:</span> db01<span class="token punctuation">,</span>db02
      db00<span class="token operator">:</span>
        driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
        url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>lottery<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>zeroDateTimeBehavior<span class="token operator">=</span>convertToNull<span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">UTC</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">true</span>
        username<span class="token operator">:</span> root
        password<span class="token operator">:</span> <span class="token number">1234</span>
      db01<span class="token operator">:</span>
        driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
        url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>lottery_01<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>zeroDateTimeBehavior<span class="token operator">=</span>convertToNull<span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">UTC</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">true</span>
        username<span class="token operator">:</span> root
        password<span class="token operator">:</span> <span class="token number">1234</span>
      db02<span class="token operator">:</span>
        driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
        url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>lottery_02<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span>utf8<span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>zeroDateTimeBehavior<span class="token operator">=</span>convertToNull<span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token constant">UTC</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">true</span>
        username<span class="token operator">:</span> root
        password<span class="token operator">:</span> <span class="token number">1234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1678696613981-6e77b90b-fe01-479f-970e-36e113a6aadf.png" alt="image.png"><code>org.springframework.boot.autoconfigure.EnableAutoConfiguration=cn.bugstack.middleware.db.router.config.DataSourceAutoConfig</code><br>这样将配置类自动注入：<code>DataSourceAutoConfig</code>，然后会去看<code>@ConditionOnMission</code>，将这个<code>JointPoint</code>类加载到容器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description: 数据源配置解析
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceAutoConfig</span> <span class="token keyword">implements</span> <span class="token class-name">EnvironmentAware</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 数据源配置组
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dataSourceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 默认数据源配置
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> defaultDataSourceConfig<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 分库数量
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> dbCount<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 分表数量
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> tbCount<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 路由字段
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> routerKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;db-router-point&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">DBRouterJoinPoint</span> <span class="token function">point</span><span class="token punctuation">(</span><span class="token class-name">DBRouterConfig</span> dbRouterConfig<span class="token punctuation">,</span> <span class="token class-name">IDBRouterStrategy</span> dbRouterStrategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterJoinPoint</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">,</span> dbRouterStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DBRouterConfig</span> <span class="token function">dbRouterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterConfig</span><span class="token punctuation">(</span>dbCount<span class="token punctuation">,</span> tbCount<span class="token punctuation">,</span> routerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Interceptor</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DynamicMybatisPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建数据源</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> targetDataSources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objMap <span class="token operator">=</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            targetDataSources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置数据源</span>
        <span class="token class-name">DynamicDataSource</span> dynamicDataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setTargetDataSources</span><span class="token punctuation">(</span>targetDataSources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dynamicDataSource<span class="token punctuation">.</span><span class="token function">setDefaultTargetDataSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span>defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultDataSourceConfig<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> dynamicDataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IDBRouterStrategy</span> <span class="token function">dbRouterStrategy</span><span class="token punctuation">(</span><span class="token class-name">DBRouterConfig</span> dbRouterConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DBRouterStrategyHashCode</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataSourceTransactionManager</span> dataSourceTransactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSourceTransactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TransactionTemplate</span> transactionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionTemplate<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span>dataSourceTransactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionTemplate<span class="token punctuation">.</span><span class="token function">setPropagationBehaviorName</span><span class="token punctuation">(</span><span class="token string">&quot;PROPAGATION_REQUIRED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token string">&quot;mini-db-router.jdbc.datasource.&quot;</span><span class="token punctuation">;</span>

        dbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;dbCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;tbCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        routerKey <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;routerKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 分库分表数据源</span>
        <span class="token class-name">String</span> dataSources <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> dataSources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dbInfo <span class="token operator">:</span> dataSources<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> dataSourceProps <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> dbInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dataSourceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>dbInfo<span class="token punctuation">,</span> dataSourceProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 默认数据源</span>
        <span class="token class-name">String</span> defaultData <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultDataSourceConfig <span class="token operator">=</span> <span class="token class-name">PropertyUtil</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> prefix <span class="token operator">+</span> defaultData<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p><a name="YlA3T"></a></p> <h3 id="根据什么路由"><a href="#根据什么路由" class="header-anchor">#</a> 根据什么路由？</h3> <ol><li>用户 ID uid 作为路由 key</li> <li>使用 <strong>斐波那契散列</strong> <a name="G9bmb"></a></li></ol> <h3 id="如何动态配置的多数据源"><a href="#如何动态配置的多数据源" class="header-anchor">#</a> 如何动态配置的多数据源？</h3> <ol><li><strong>继承</strong><code>**extends AbstractRoutingDataSource**</code></li> <li><strong>实现</strong><code>**determineCurrentLookupKey()**</code><strong>：根据返回值去配置 Map 内取对应的数据源配置</strong></li> <li><strong>然后每次切换数据源都会过一遍这个方法，设置数据源</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description: 动态数据源获取，每当切换数据源，都要从这个里面进行获取
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDataSource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;db&quot;</span> <span class="token operator">+</span> <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">getDBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><a name="v8bdP"></a></p> <h3 id="如何进行分库"><a href="#如何进行分库" class="header-anchor">#</a> 如何进行分库？</h3> <p>这个类是 Java 的 jdbc 的，这是 SPI 机制，由 MySQL 驱动去实现</p> <p>spring 中有一个抽象类<code>AbstractRoutingDataSource</code>，重写其<code>determineCurrentLookupKey()</code>将获得数据源，如：<img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1677423848767-16a412d0-b377-4d1a-877a-1d87bd24e316.png#averageHue=%23f4f2e9&amp;clientId=u5e85d151-48e6-4&amp;from=paste&amp;height=120&amp;id=u21ff6f26&amp;name=image.png&amp;originHeight=240&amp;originWidth=1144&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=52155&amp;status=done&amp;style=stroke&amp;taskId=u8f7f6140-61a9-472c-b189-e4a2d9bfb38&amp;title=&amp;width=572" alt="image.png"><br>DBRouter 将<code>dbKey``tbKey</code>放在两个 ThreadLocal 中：<img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677423951588-faeafb27-6dbf-4a66-a6db-6aaeebde4b9d.png" alt="image.png"><br>凡是加了<code>@DBRouter</code>的注解都是分库了：</p> <ol><li>使用 <strong>AOP @Aspect</strong> 切面拦截，调用<code>IDBRouterStrategy.dbRouter(Uid)</code>进行路由（即随机出一个 dbKey 和 tbKey）</li> <li>然后在获取数据库连接，会调用上面的<code>DynamicDataSource</code>配置到动态源，AbstractRoutingDataSource，会获取当前数据库配置源：就会走重写的<code>determineCurrentLookupKey()</code></li> <li>完成** 分库**</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 所有需要分库分表的操作，都需要使用自定义注解进行拦截，拦截后读取方法中的入参字段，根据字段进行路由操作。
 * 1. dbRouter.key() 确定根据哪个字段进行路由
 * 2. getAttrValue 根据数据库路由字段，从入参中读取出对应的值。比如路由 key 是 uId，那么就从入参对象 Obj 中获取到 uId 的值。
 * 3. dbRouterStrategy.doRouter(dbKeyAttr) 路由策略根据具体的路由值进行处理
 * 4. 路由处理完成比，就是放行。 jp.proceed();
 * 5. 最后 dbRouterStrategy 需要执行 clear 因为这里用到了 ThreadLocal 需要手动清空。关于 ThreadLocal 内存泄漏介绍 https://t.zsxq.com/027QF2fae
 */</span>
<span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> jp<span class="token punctuation">,</span> <span class="token class-name">DBRouter</span> dbRouter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> dbKey <span class="token operator">=</span> dbRouter<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dbRouterConfig<span class="token punctuation">.</span><span class="token function">getRouterKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;annotation DBRouter key is null！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dbKey <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">)</span> <span class="token operator">?</span> dbKey <span class="token operator">:</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getRouterKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 路由属性</span>
    <span class="token class-name">String</span> dbKeyAttr <span class="token operator">=</span> <span class="token function">getAttrValue</span><span class="token punctuation">(</span>dbKey<span class="token punctuation">,</span> jp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 路由策略</span>
    dbRouterStrategy<span class="token punctuation">.</span><span class="token function">doRouter</span><span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回结果</span>
    <span class="token comment">// 内部mybatis执行时，会执行 determineLookUpKey 导航到对应的DataSource</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
       dbRouterStrategy<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><a name="K3ay6"></a></p> <h3 id="如何进行分表-如何拦截-mybatis"><a href="#如何进行分表-如何拦截-mybatis" class="header-anchor">#</a> 如何进行分表/如何拦截 Mybatis</h3> <blockquote><p>区分分库 分表</p></blockquote> <ul><li>实现<code>Interceptor</code>接口，重写<code>intercept</code>方法</li></ul> <p>Mybatis 自定义插件针对 Mybatis 四大对象（Executor、StatementHandler 、ParameterHandler 、ResultSetHandler ）进行拦截，具体拦截方式为：</p> <ul><li><code>**Executor**</code>：拦截执行器的方法(log 记录)</li> <li><code>**StatementHandler**</code> ：拦截 Sql 语法构建的处理
<ul><li>method 为拦截的方法，<code>**method** = &quot;**prepare**&quot;</code>拦截预处理方法</li></ul></li> <li><code>**ParameterHandler**</code> ：拦截参数的处理</li> <li><code>**ResultSetHandler**</code> ：拦截结果集的处理</li></ul> <blockquote><p>使用反射</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description: Mybatis 拦截器，通过对 SQL 语句的拦截处理，修改分表信息（使用正则+反射）
 */</span>
<span class="token comment">//</span>
<span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StatementHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">&quot;prepare&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicMybatisPlugin</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>

    <span class="token comment">// 这个正则表达式匹配以 &quot;from&quot;、&quot;into&quot; 或者 &quot;update&quot; 开头，后面跟着至少一个空格，然后紧跟着一个或多个字母数字字符（即一个单词）。</span>
    <span class="token keyword">private</span> <span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;(from|into|update)[\\s]{1,}(\\w{1,})&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token constant">CASE_INSENSITIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取StatementHandler</span>
        <span class="token class-name">StatementHandler</span> statementHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> invocation<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MetaObject</span> metaObject <span class="token operator">=</span> <span class="token class-name">MetaObject</span><span class="token punctuation">.</span><span class="token function">forObject</span><span class="token punctuation">(</span>statementHandler<span class="token punctuation">,</span> <span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_OBJECT_FACTORY</span><span class="token punctuation">,</span> <span class="token class-name">SystemMetaObject</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_OBJECT_WRAPPER_FACTORY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MappedStatement</span> mappedStatement <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedStatement</span><span class="token punctuation">)</span> metaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">&quot;delegate.mappedStatement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取自定义注解判断是否进行分表操作</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DBRouterStrategy</span> dbRouterStrategy <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">DBRouterStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// // 加上DBRouter是分库，分表只有 user_strategt_export 分表</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> dbRouterStrategy <span class="token operator">||</span> <span class="token operator">!</span>dbRouterStrategy<span class="token punctuation">.</span><span class="token function">splitTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取SQL 并 替换SQL</span>
        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> statementHandler<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 替换SQL表名 USER 为 USER_03</span>
        <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> tableName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tableName <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">assert</span> <span class="token keyword">null</span> <span class="token operator">!=</span> tableName<span class="token punctuation">;</span>
        <span class="token class-name">String</span> replaceSql <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>tableName <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">getTBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过反射修改SQL语句</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;sql&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> replaceSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ExamplePlugin.java</span>
<span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>
    type<span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
    method <span class="token operator">=</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span>
    args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExamplePlugin</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> target <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//被代理对象</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//代理方法</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//方法参数</span>
            <span class="token comment">// do something ...... 方法拦截前执行代码块</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// do something .......方法拦截后执行代码块</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677046353474-f3316ed0-7052-4320-9af8-be1e6cca3d48.png" alt="image.png"> <a name="dFck9"></a></p> <h4 id="时序图"><a href="#时序图" class="header-anchor">#</a> 时序图</h4> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677047163315-ede7f5bf-8e64-4d99-819f-714872088a3c.png" alt="image.png"></p> <hr> <p><a name="V5KwA"></a></p> <h2 id="十一、「编程式事务」领取活动领域开发"><a href="#十一、「编程式事务」领取活动领域开发" class="header-anchor">#</a> 十一、「编程式事务」领取活动领域开发</h2> <blockquote><p><a href="https://t.zsxq.com/qzFAAuB" target="_blank" rel="noopener noreferrer">https://t.zsxq.com/qzFAAuB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <ul><li><p>声明式事务：在 AOP 基础上，对方法前后进行拦截，方法前开始事务，方法后提交事务</p></li> <li><p>编程式事务：利用<code>TransactionTemplate</code>主动进行事务的开启</p> <p><strong>没有用到分库分表直接用的就是声明事务：</strong><code>**@Transaction**</code><br><strong>用到分库分表的都是</strong><code>**TransactionTemplate.execute()**</code><strong>：，需要先进行 dbRouter.deRouter() 否则只会数据源变动事务会失效</strong></p> <p><a name="HjXXh"></a></p></li></ul> <h3 id="_1-自研组件-dbrouter-扩展事务"><a href="#_1-自研组件-dbrouter-扩展事务" class="header-anchor">#</a> 1. 自研组件 DBRouter 扩展事务</h3> <ul><li>问题：如果一个场景需要在同一个事务下，连续操作不同的 DAO 操作，那么就会涉及到在 DAO 上使用注解 @DBRouter(key = &quot;uId&quot;) 反复切换路由的操作。虽然都是一个数据源，但这样切换后，事务就没法处理了。
<ul><li>每次进行 DAO 都会进行<code>doRouter()</code>：因为在<code>@DBRouter</code>切面拦截会进行</li></ul></li> <li>解决：这里选择了一个较低的成本的解决方案，就是把数据源的切换放在事务处理前，而事务操作也通过编程式编码进行处理。<em>具体可以参考 db-router-spring-boot-starter 源码</em> <a name="B6ky5"></a></li></ul> <h4 id="_1-拆解路由策略-单独提供路由方法"><a href="#_1-拆解路由策略-单独提供路由方法" class="header-anchor">#</a> ① 拆解路由策略，单独提供路由方法</h4> <ul><li>把路由算法拆解出来，无论是切面中还是硬编码，都通过这个方法进行计算路由</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDBRouterStrategy</span> <span class="token punctuation">{</span>

    <span class="token keyword">void</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbKeyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// doRouter接口实现</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbKeyAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getDbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 扰动函数；在 JDK 的 HashMap 中，对于一个元素的存放，需要进行哈希散列。而为了让散列更加均匀，所以添加了扰动函数。扩展学习；https://mp.weixin.qq.com/s/CySTVqEDK9-K1MRUwBKRCg</span>
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>dbKeyAttr<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 库表索引；相当于是把一个长条的桶，切割成段，对应分库分表中的库编号和表编号</span>
    <span class="token keyword">int</span> dbIdx <span class="token operator">=</span> idx <span class="token operator">/</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tbIdx <span class="token operator">=</span> idx <span class="token operator">-</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>dbIdx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置到 ThreadLocal</span>
    <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%02d&quot;</span><span class="token punctuation">,</span> dbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%03d&quot;</span><span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;数据库路由 dbIdx：{} tbIdx：{}&quot;</span><span class="token punctuation">,</span>  dbIdx<span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><a name="hRLsv"></a></p> <h4 id="_2-配置事务对象"><a href="#_2-配置事务对象" class="header-anchor">#</a> ② 配置事务对象</h4> <ul><li>创建路由策略对象，便于切面和硬编码注入使用。</li> <li>创建事务对象，用于编程式事务引入</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">TransactionTemplate</span> <span class="token function">transactionTemplate</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionManager</span> dataSourceTransactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSourceTransactionManager<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TransactionTemplate</span> transactionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionTemplate<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span>dataSourceTransactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    transactionTemplate<span class="token punctuation">.</span><span class="token function">setPropagationBehaviorName</span><span class="token punctuation">(</span><span class="token string">&quot;PROPAGATION_REQUIRED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><a name="dFsbI"></a></p> <h3 id="_2-活动领取模板抽象类-模板模式"><a href="#_2-活动领取模板抽象类-模板模式" class="header-anchor">#</a> 2. 活动领取模板抽象类（模板模式</h3> <ul><li>抽象类 BaseActivityPartake 继承数据支撑类并实现接口方法 IActivityPartake#doPartake</li> <li>在领取活动 doPartake 方法中，先是通过父类提供的数据服务，获取到活动账单，再定义三个抽象方法：活动信息校验处理、扣减活动库存、领取活动，依次顺序解决活动的领取操作。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">PartakeResult</span> <span class="token function">doPartake</span><span class="token punctuation">(</span><span class="token class-name">PartakeReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1. 查询是否存在未执行抽奖领取活动单【user_take_activity 存在 state = 0，领取了但抽奖过程失败的，可以直接返回领取结果继续抽奖】</span>
    <span class="token class-name">UserTakeActivityVO</span> userTakeActivityVO <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryNoConsumedTakeActivityOrder</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> userTakeActivityVO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">buildPartakeResult</span><span class="token punctuation">(</span>userTakeActivityVO<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userTakeActivityVO<span class="token punctuation">.</span><span class="token function">getTakeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 查询活动账单</span>
    <span class="token class-name">ActivityBillVO</span> activityBillVO <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">queryActivityBill</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 活动信息校验处理【活动库存、状态、日期、个人参与次数】</span>
    <span class="token class-name">Result</span> checkResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkActivityBill</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> activityBillVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>checkResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PartakeResult</span><span class="token punctuation">(</span>checkResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> checkResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 扣减活动库存【目前为直接对配置库中的 lottery.activity 直接操作表扣减库存，后续优化为Redis扣减】</span>
    <span class="token class-name">Result</span> subtractionActivityResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">subtractionActivityStock</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>subtractionActivityResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PartakeResult</span><span class="token punctuation">(</span>subtractionActivityResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subtractionActivityResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 插入领取活动信息【个人用户把活动信息写入到用户表】</span>
    <span class="token class-name">Long</span> takeId <span class="token operator">=</span> idGeneratorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>Ids<span class="token punctuation">.</span>SnowFlake</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Result</span> grabResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">grabActivity</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> activityBillVO<span class="token punctuation">,</span> takeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grabResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PartakeResult</span><span class="token punctuation">(</span>grabResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grabResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">buildPartakeResult</span><span class="token punctuation">(</span>activityBillVO<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> takeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    <span class="token comment">/**
     * 活动信息校验处理，把活动库存、状态、日期、个人参与次数
     *
     * @param partake 参与活动请求
     * @param bill    活动账单
     * @return 校验结果
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">checkActivityBill</span><span class="token punctuation">(</span><span class="token class-name">PartakeReq</span> partake<span class="token punctuation">,</span> <span class="token class-name">ActivityBillVO</span> bill<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 扣减活动库存
     *
     * @param req 参与活动请求
     * @return 扣减结果
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">subtractionActivityStock</span><span class="token punctuation">(</span><span class="token class-name">PartakeReq</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 领取活动
     *
     * @param partake 参与活动请求
     * @param bill    活动账单
     * @return 领取结果
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Result</span> <span class="token function">grabActivity</span><span class="token punctuation">(</span><span class="token class-name">PartakeReq</span> partake<span class="token punctuation">,</span> <span class="token class-name">ActivityBillVO</span> bill<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>第 4 步和第 5 步要使用「MySQL-Redis」事务一致性，后面通过 Redis 分布式锁做到
<a name="qS26v"></a></p> <h3 id="_3-领取活动编程式事务处理"><a href="#_3-领取活动编程式事务处理" class="header-anchor">#</a> 3. 领取活动编程式事务处理</h3> <ul><li>dbRouter.doRouter(partake.getuId()); 是编程式处理分库分表，如果在不需要使用事务的场景下，直接使用注解配置到 DAO 方法上即可。<em>两个方式不能混用</em></li> <li>transactionTemplate.execute 是编程式事务，用的就是路由中间件提供的事务对象，通过这样的方式也可以更加方便的处理细节的回滚，而不需要抛异常处理。</li></ul> <p>第 5 步的<code>this.grabActivity()</code>需要使用事务保证一致性：操作<img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677053212749-603516a1-fb3a-47f7-a4ed-4858a0679e32.png" alt="image.png">这两个表</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Result</span> <span class="token function">grabActivity</span><span class="token punctuation">(</span><span class="token class-name">PartakeReq</span> partake<span class="token punctuation">,</span> <span class="token class-name">ActivityBillVO</span> bill<span class="token punctuation">,</span> <span class="token class-name">Long</span> takeId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先进行数据路由散列，保证之后用的都是同一个Connection</span>
        dbRouter<span class="token punctuation">.</span><span class="token function">doRouter</span><span class="token punctuation">(</span>partake<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// transactionTemplate编程式事务</span>
        <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 扣减个人已参与次数</span>
                <span class="token keyword">int</span> updateCount <span class="token operator">=</span> userTakeActivityRepository<span class="token punctuation">.</span><span class="token function">subtractionLeftCount</span><span class="token punctuation">(</span>bill<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getTakeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getUserTakeLeftCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> updateCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    status<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;领取活动，扣减个人已参与次数失败 activityId：{} uId：{}&quot;</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">NO_UPDATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 写入领取活动记录</span>
                userTakeActivityRepository<span class="token punctuation">.</span><span class="token function">takeActivity</span><span class="token punctuation">(</span>bill<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getTakeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bill<span class="token punctuation">.</span><span class="token function">getUserTakeLeftCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getPartakeDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> takeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                status<span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;领取活动，唯一索引冲突 activityId：{} uId：{}&quot;</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partake<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">INDEX_DUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">buildSuccessResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        dbRouter<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><a name="rpDkU"></a></p> <h3 id="声明式编程-transaction"><a href="#声明式编程-transaction" class="header-anchor">#</a> 声明式编程 @Transaction</h3> <hr> <p><a name="cvyWc"></a></p> <h2 id="十二、在应用层编排抽奖过程"><a href="#十二、在应用层编排抽奖过程" class="header-anchor">#</a> 十二、在应用层编排抽奖过程</h2> <p><strong>在</strong><code>**lottery-application**</code><strong>应用启动模块，编排整个的抽奖过程：</strong></p> <ol><li><strong>领取活动</strong> <ol><li><strong>首次领取 发送 MQ 执行库存扣除</strong></li> <li><strong>如果还有已领取未消费的 就不领取 ，用这个旧的</strong></li></ol></li> <li><strong>执行抽奖</strong></li> <li><strong>结果落库</strong></li> <li><strong>发送 MQ，触发发奖过程</strong></li> <li><strong>返回结果</strong></li></ol> <blockquote><p>整个抽奖过程也是按照 DDD 结构来的，抽象成一个<code>process</code>包，它的实现其实就是一层浅封装（封装之前实现的各个模块）</p></blockquote> <p><a name="iQfgQ"></a></p> <h3 id="_1-编排流程"><a href="#_1-编排流程" class="header-anchor">#</a> 1. 编排流程</h3> <p>对于每一个流程节点编排的内容，<strong>都是在领域层开发完成的，而应用层只是做最为简单的且很薄的一层</strong>。<em>其实这块也很符合目前很多低代码的使用场景，通过界面可视化控制流程编排，生成代码</em></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">DrawProcessResult</span> <span class="token function">doDrawProcess</span><span class="token punctuation">(</span><span class="token class-name">DrawProcessReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 领取活动</span>
    <span class="token class-name">PartakeResult</span> partakeResult <span class="token operator">=</span> activityPartake<span class="token punctuation">.</span><span class="token function">doPartake</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PartakeReq</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果有已领取但还没使用的就先用这个旧的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">NOT_CONSUMED_TAKE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partakeResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 首次成功领取活动，发送 MQ 消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ActivityPartakeRecordVO</span> activityPartakeRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityPartakeRecordVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setuId</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setStockSurplusCount</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getStockSurplusCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送 MQ 消息：LotteryActivityPartakeRecord 记录抽奖行为</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryActivityPartakeRecord</span><span class="token punctuation">(</span>activityPartakeRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Long</span> strategyId <span class="token operator">=</span> partakeResult<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> takeId <span class="token operator">=</span> partakeResult<span class="token punctuation">.</span><span class="token function">getTakeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 执行抽奖</span>
    <span class="token class-name">DrawResult</span> drawResult <span class="token operator">=</span> drawExec<span class="token punctuation">.</span><span class="token function">doDrawExec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawReq</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strategyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>DrawState</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>drawResult<span class="token punctuation">.</span><span class="token function">getDrawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">LOSING_DRAW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">LOSING_DRAW</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DrawAwardVO</span> drawAwardVO <span class="token operator">=</span> drawResult<span class="token punctuation">.</span><span class="token function">getDrawAwardInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 结果落库</span>
    <span class="token class-name">DrawOrderVO</span> drawOrderVO <span class="token operator">=</span> <span class="token function">buildDrawOrderVO</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> strategyId<span class="token punctuation">,</span> takeId<span class="token punctuation">,</span> drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Result</span> recordResult <span class="token operator">=</span> activityPartake<span class="token punctuation">.</span><span class="token function">recordDrawOrder</span><span class="token punctuation">(</span>drawOrderVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>recordResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span>recordResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> recordResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 发送MQ，触发发奖流程：发奖 调用奖品工厂模式</span>
    <span class="token class-name">InvoiceVO</span> invoiceVO <span class="token operator">=</span> <span class="token function">buildInvoiceVO</span><span class="token punctuation">(</span>drawOrderVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryInvoice</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListenableFutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stringObjectSendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.1 MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span>
            activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span><span class="token constant">COMPLETE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.2 MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span>
            activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 返回结果</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677056276591-8a95282b-46bf-4a2f-8e50-f1848bc0dbdd.png" alt="image.png"> <a name="E61jf"></a></p> <h3 id="幂等性保证-⭐️⭐️⭐️"><a href="#幂等性保证-⭐️⭐️⭐️" class="header-anchor">#</a> 幂等性保证 ⭐️⭐️⭐️</h3> <p><a name="qC3Oz"></a></p> <h4 id="_1-用户参与活动只参与一次-user-take-activity"><a href="#_1-用户参与活动只参与一次-user-take-activity" class="header-anchor">#</a> 1. 用户参与活动只参与一次 <code>user_take_activity</code></h4> <p>在<code>user_take_activity</code>用一个 state 字段保证，0 就是无参与，1 是参与了，这样只消费一次（看见 1 就不消费了）
<a name="j2cfS"></a></p> <h4 id="_2-用户发奖只发一次user-export-strategy"><a href="#_2-用户发奖只发一次user-export-strategy" class="header-anchor">#</a> 2. 用户发奖只发一次<code>user_export_strategy</code></h4> <p>因为活动只参与一次，所以活动 take_id 应该是唯一的，如果有重复的活动进来了 那么就会报重复 也不能插入<br>上面保证了一次（只消费一次），然后用<code>takeId</code>保证唯一索引，这个 takeId 是<code>user_take_activity</code>内的，只会生成一次（领取活动的单号作为 ID），如果再来重复消费，他不会重新生成，而是报错回滚</p> <hr> <p><a name="nhgMv"></a></p> <h2 id="十三、组合模式-规则引擎量化人群参与活动"><a href="#十三、组合模式-规则引擎量化人群参与活动" class="header-anchor">#</a> 十三、组合模式：规则引擎量化人群参与活动</h2> <p><a name="Pw9q3"></a></p> <h3 id="_1-组合模式"><a href="#_1-组合模式" class="header-anchor">#</a> 1. 组合模式</h3> <p>组合模式：<a href="https://baijiahao.baidu.com/s?id=1711869421433076203&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener noreferrer">https://baijiahao.baidu.com/s?id=1711869421433076203&amp;wfr=spider&amp;for=pc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672927987359-0c2d7a4e-2b61-4fe0-896c-3618f4d874c6.png" alt="image.png" title="组合模式"></p> <blockquote><p><code>Component</code>是一个抽象类</p> <ul><li>接口<code>Interface</code>用来约束行为</li> <li>抽象<code>abstract</code>用来定义能力</li> <li>对于<code>abstract</code>，<strong><em>方法如果是</em></strong><code>**_abstract_**</code><strong><em>修饰，那么子类必须实现</em></strong>，所以可以使用<code>public/protected</code>则子类可有选择的实现重写</li> <li>抽象方法必须存在于抽象类，但是抽象类可以有具体方法，子类直接使用（就和普通的父类一样）</li> <li>抽象类不能<code>new</code>，接口也是，都是让 new 子类</li></ul></blockquote> <p><a name="I5V0m"></a></p> <h3 id="_2-数据库设计"><a href="#_2-数据库设计" class="header-anchor">#</a> 2. 数据库设计</h3> <blockquote><p>先看视频：<a href="https://wx.zsxq.com/dweb2/index/topic_detail/581111448222454" target="_blank" rel="noopener noreferrer">https://wx.zsxq.com/dweb2/index/topic_detail/581111448222454<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>Lottery 对规则就是用到了组合模式：存在于三个表内<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1672928909123-2d23b576-3b19-4a44-a649-dc921923bc32.png" alt="image.png"> <a name="bP0za"></a></p> <h3 id="三、应用场景"><a href="#三、应用场景" class="header-anchor">#</a> 三、应用场景</h3> <p>说是过滤器，其实说法不对，而是一个<strong>分类器：</strong></p> <ul><li><strong>即用户进入，根据用户的信息（性别、年龄）给给到对应的活动上</strong></li> <li><strong>这个过程是一个决策的过程，所以叫决策树</strong></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1673265176729-12709f87-2bcd-4486-966c-7163e0d5829b.png#averageHue=%23ececec&amp;clientId=uc5cb509a-7336-4&amp;from=paste&amp;height=365&amp;id=u1b7cf4c8&amp;name=image.png&amp;originHeight=1020&amp;originWidth=1856&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=436851&amp;status=done&amp;style=none&amp;taskId=u83ec63a7-a414-45c9-a051-ec73499b524&amp;title=&amp;width=664" alt="image.png"><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1673275573789-82bd0a0d-f445-4c66-afc0-0b59873dba67.png" alt="image.png"></p> <p><a name="AvQEu"></a></p> <h3 id="四、功能开发"><a href="#四、功能开发" class="header-anchor">#</a> 四、功能开发</h3> <p>重新构建一个<code>rule</code>领域，领域服务包含：</p> <ul><li><code>logic</code>：负责具体的节点过滤</li> <li><code>engine</code>：负责整体的筛选，即从根节点到叶子结点的活动这个流程控制</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1673265655072-735847ab-e8a1-47f6-aa6a-8ad6c2177675.png#averageHue=%23cbc19c&amp;clientId=uc5cb509a-7336-4&amp;from=paste&amp;height=614&amp;id=u6a3e4c4a&amp;name=image.png&amp;originHeight=1228&amp;originWidth=1872&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=869872&amp;status=done&amp;style=none&amp;taskId=ud1e0c2ed-458a-4224-9c68-98ac9f6554b&amp;title=&amp;width=936" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1673265756935-b79b1301-ceba-4cd3-be01-74c7e3c295a9.png#averageHue=%23dbdbdb&amp;clientId=uc5cb509a-7336-4&amp;from=paste&amp;height=271&amp;id=u7493b5c7&amp;name=image.png&amp;originHeight=542&amp;originWidth=446&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=47617&amp;status=done&amp;style=none&amp;taskId=ud23f4d70-8a31-4aee-9fa4-4cf75198629&amp;title=&amp;width=223" alt="image.png"><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1673273032843-3a5b33cc-f4de-4d0e-84c5-48ed77791aa9.png" alt="image.png" title="来源：https://wx.zsxq.com/dweb2/index/topic_detail/185581121521412"> <a name="WFxTX"></a></p> <h4 id="engine领域服务-编排整个过滤的流程"><a href="#engine领域服务-编排整个过滤的流程" class="header-anchor">#</a> <code>engine</code>领域服务：编排整个过滤的流程</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 规则配置，导入规则实体，存入一个Map：logicFilterMap</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EngineConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LogicFilter</span><span class="token punctuation">&gt;</span></span> logicFilterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserAgeFilter</span> userAgeFilter<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">UserGenderFilter</span> userGenderFilter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logicFilterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userAge&quot;</span><span class="token punctuation">,</span> userAgeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logicFilterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userGender&quot;</span><span class="token punctuation">,</span> userGenderFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EngineFilter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 规则过滤器接口
     *
     * @param matter      规则决策值
     * @return            规则决策结果
     */</span>
    <span class="token class-name">EngineResult</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DecisionMatterReq</span> matter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 完成整个规则过滤的过程
 *
 * @param treeRuleRich     	整个规则树
 * @param matter     		决策值，内部包含一个map，如 &lt;age,25&gt; &lt;gender,male&gt;
 * @return            		规则决策结果，即过滤到了最后的叶子结点，内含「活动ID」，过滤完成
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">TreeNodeVO</span> <span class="token function">engineDecisionMaker</span><span class="token punctuation">(</span><span class="token class-name">TreeRuleRich</span> treeRuleRich<span class="token punctuation">,</span> <span class="token class-name">DecisionMatterReq</span> matter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TreeRootVO</span> treeRoot <span class="token operator">=</span> treeRuleRich<span class="token punctuation">.</span><span class="token function">getTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">TreeNodeVO</span><span class="token punctuation">&gt;</span></span> treeNodeMap <span class="token operator">=</span> treeRuleRich<span class="token punctuation">.</span><span class="token function">getTreeNodeMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获得规则树 树根节点</span>
    <span class="token class-name">Long</span> rootNodeId <span class="token operator">=</span> treeRoot<span class="token punctuation">.</span><span class="token function">getTreeRootNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TreeNodeVO</span> treeNodeInfo <span class="token operator">=</span> treeNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rootNodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 节点类型[NodeType]；1 非叶子结点、2 叶子节点</span>
    <span class="token comment">// STEM根茎，即非叶子节点</span>
    <span class="token comment">// 如果节点是非叶子结点，那么就要执行对应的规则过滤了</span>
    <span class="token comment">// 循环退出时，是到了叶子结点了</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>NodeType</span><span class="token punctuation">.</span><span class="token constant">STEM</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>treeNodeInfo<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先取得该节点对应的过滤规则实体</span>
        <span class="token class-name">String</span> ruleKey <span class="token operator">=</span> treeNodeInfo<span class="token punctuation">.</span><span class="token function">getRuleKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogicFilter</span> logicFilter <span class="token operator">=</span> logicFilterMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ruleKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获得该过滤规则的对照值</span>
        <span class="token class-name">String</span> matterValue <span class="token operator">=</span> logicFilter<span class="token punctuation">.</span><span class="token function">matterValue</span><span class="token punctuation">(</span>matter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//进行过滤，获得下一层的节点Id</span>
        <span class="token class-name">Long</span> nextNode <span class="token operator">=</span> logicFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>matterValue<span class="token punctuation">,</span> treeNodeInfo<span class="token punctuation">.</span><span class="token function">getTreeNodeLineInfoList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得下一层节点对应的过滤规则实体</span>
        treeNodeInfo <span class="token operator">=</span> treeNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;决策树引擎=&gt;{} userId：{} treeId：{} treeNode：{} ruleKey：{} matterValue：{}&quot;</span><span class="token punctuation">,</span> treeRoot<span class="token punctuation">.</span><span class="token function">getTreeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matter<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matter<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> treeNodeInfo<span class="token punctuation">.</span><span class="token function">getTreeNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleKey<span class="token punctuation">,</span> matterValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最后返回的是 叶子结点，即过滤到了对应的活动ID</span>
    <span class="token keyword">return</span> treeNodeInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;ruleEngineHandle&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuleEngineHandle</span> <span class="token keyword">extends</span> <span class="token class-name">EngineBase</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IRuleRepository</span> ruleRepository<span class="token punctuation">;</span>

    <span class="token comment">// 对内部过滤进行了一层封装</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">EngineResult</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">DecisionMatterReq</span> matter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得完整的「决策规则树」</span>
        <span class="token class-name">TreeRuleRich</span> treeRuleRich <span class="token operator">=</span> ruleRepository<span class="token punctuation">.</span><span class="token function">queryTreeRuleRich</span><span class="token punctuation">(</span>matter<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> treeRuleRich<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Tree Rule is null!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获得决策节点</span>
        <span class="token comment">// matter是一个Map，由内部对应的 UserAgeFilter UserGenderFilter进行对比</span>
        <span class="token class-name">TreeNodeVO</span> treeNodeInfo <span class="token operator">=</span> <span class="token function">engineDecisionMaker</span><span class="token punctuation">(</span>treeRuleRich<span class="token punctuation">,</span> matter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 决策结果</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EngineResult</span><span class="token punctuation">(</span>matter<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> treeNodeInfo<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> treeNodeInfo<span class="token punctuation">.</span><span class="token function">getTreeNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> treeNodeInfo<span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><a name="MlxEK"></a></p> <h4 id="logic领域服务-负责具体的每个规则过滤"><a href="#logic领域服务-负责具体的每个规则过滤" class="header-anchor">#</a> <code>logic</code>领域服务：负责具体的每个规则过滤</h4> <p>login 负责具体的节点过滤服务，即对每个节点进行对应的过滤：对性别判别，对年龄判别。<br>注入到了<code>EngineConfig</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LogicFilter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 逻辑决策器
     * @param matterValue          决策值
     * @param treeNodeLineInfoList 决策节点
     * @return                     下一个节点Id
     */</span>
    <span class="token class-name">Long</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> matterValue<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNodeLineVO</span><span class="token punctuation">&gt;</span></span> treeNodeLineInfoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取决策值
     *
     * @param decisionMatter 决策物料
     * @return               决策值
     */</span>
    <span class="token class-name">String</span> <span class="token function">matterValue</span><span class="token punctuation">(</span><span class="token class-name">DecisionMatterReq</span> decisionMatter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseLogic</span> <span class="token keyword">implements</span> <span class="token class-name">LogicFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> matterValue<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNodeLineVO</span><span class="token punctuation">&gt;</span></span> treeNodeLineInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// treeNodeLineInfoList 只包含两个TreeNodeLineVO，因为是一个节点的 左右子树的连线</span>
        <span class="token comment">// 所以这两个一定会返回一个结果为 true</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TreeNodeLineVO</span> nodeLine <span class="token operator">:</span> treeNodeLineInfoList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">decisionLogic</span><span class="token punctuation">(</span>matterValue<span class="token punctuation">,</span> nodeLine<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> nodeLine<span class="token punctuation">.</span><span class="token function">getNodeIdTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Constants<span class="token punctuation">.</span>Global</span><span class="token punctuation">.</span><span class="token constant">TREE_NULL_NODE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取规则比对值
     * @param decisionMatter 决策物料
     * @return 比对值
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">String</span> <span class="token function">matterValue</span><span class="token punctuation">(</span><span class="token class-name">DecisionMatterReq</span> decisionMatter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 具体的某个规则实体 获得过滤结果</span>
    <span class="token comment">// 数据库使用1-7字段进行一一对应</span>
    <span class="token comment">// 要和数据库的设计对应上 ⭐️⭐️⭐️⭐️⭐️</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">decisionLogic</span><span class="token punctuation">(</span><span class="token class-name">String</span> matterValue<span class="token punctuation">,</span> <span class="token class-name">TreeNodeLineVO</span> nodeLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RuleLimitType</span><span class="token punctuation">.</span><span class="token constant">EQUAL</span><span class="token operator">:</span>
                <span class="token keyword">return</span> matterValue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RuleLimitType</span><span class="token punctuation">.</span><span class="token constant">GT</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>matterValue<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RuleLimitType</span><span class="token punctuation">.</span><span class="token constant">LT</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>matterValue<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RuleLimitType</span><span class="token punctuation">.</span><span class="token constant">GE</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>matterValue<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RuleLimitType</span><span class="token punctuation">.</span><span class="token constant">LE</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>matterValue<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAgeFilter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseLogic</span> <span class="token punctuation">{</span>

    <span class="token comment">// 自己完全可以自定义一些其他校验规则</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">matterValue</span><span class="token punctuation">(</span><span class="token class-name">DecisionMatterReq</span> decisionMatter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> decisionMatter<span class="token punctuation">.</span><span class="token function">getValMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserGenderFilter</span> <span class="token keyword">extends</span> <span class="token class-name">BaseLogic</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">matterValue</span><span class="token punctuation">(</span><span class="token class-name">DecisionMatterReq</span> decisionMatter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> decisionMatter<span class="token punctuation">.</span><span class="token function">getValMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><a name="NsGH9"></a></p> <h4 id="构建规则树querytreerulerich-⭐️⭐️⭐️"><a href="#构建规则树querytreerulerich-⭐️⭐️⭐️" class="header-anchor">#</a> 构建规则树<code>queryTreeRuleRich</code> ⭐️⭐️⭐️</h4> <p><strong>原理：先查询所有属于这颗数的 Node，然后 for 每一个 Node，看这个 Node 的 NodeLine（通过传入 TreeID &amp; IdFrom）</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TreeRuleRich</span> <span class="token function">queryTreeRuleRich</span><span class="token punctuation">(</span><span class="token class-name">Long</span> treeId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 规则树</span>
    <span class="token class-name">RuleTree</span> ruleTree <span class="token operator">=</span> ruleTreeDao<span class="token punctuation">.</span><span class="token function">queryRuleTreeByTreeId</span><span class="token punctuation">(</span>treeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TreeRootVO</span> treeRoot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeRootVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    treeRoot<span class="token punctuation">.</span><span class="token function">setTreeId</span><span class="token punctuation">(</span>ruleTree<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    treeRoot<span class="token punctuation">.</span><span class="token function">setTreeRootNodeId</span><span class="token punctuation">(</span>ruleTree<span class="token punctuation">.</span><span class="token function">getTreeRootNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    treeRoot<span class="token punctuation">.</span><span class="token function">setTreeName</span><span class="token punctuation">(</span>ruleTree<span class="token punctuation">.</span><span class="token function">getTreeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 树节点-&gt;树连接线</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">TreeNodeVO</span><span class="token punctuation">&gt;</span></span> treeNodeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 rootId 查询出这棵树的所有节点</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RuleTreeNode</span><span class="token punctuation">&gt;</span></span> ruleTreeNodeList <span class="token operator">=</span> ruleTreeNodeDao<span class="token punctuation">.</span><span class="token function">queryRuleTreeNodeList</span><span class="token punctuation">(</span>treeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RuleTreeNode</span> treeNode <span class="token operator">:</span> ruleTreeNodeList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TreeNodeLineVO</span><span class="token punctuation">&gt;</span></span> treeNodeLineInfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果节点是非叶子节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>NodeType</span><span class="token punctuation">.</span><span class="token constant">STEM</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 查询此节点的两个左右子节点（根据TreeId 和 NodeIdFrom一定能查出两个左右孩子）</span>
            <span class="token class-name">RuleTreeNodeLine</span> ruleTreeNodeLineReq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuleTreeNodeLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ruleTreeNodeLineReq<span class="token punctuation">.</span><span class="token function">setTreeId</span><span class="token punctuation">(</span>treeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ruleTreeNodeLineReq<span class="token punctuation">.</span><span class="token function">setNodeIdFrom</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RuleTreeNodeLine</span><span class="token punctuation">&gt;</span></span> ruleTreeNodeLineList <span class="token operator">=</span> ruleTreeNodeLineDao<span class="token punctuation">.</span><span class="token function">queryRuleTreeNodeLineList</span><span class="token punctuation">(</span>ruleTreeNodeLineReq<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 遍历这两个左右子孩子的线</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RuleTreeNodeLine</span> nodeLine <span class="token operator">:</span> ruleTreeNodeLineList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">TreeNodeLineVO</span> treeNodeLineInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNodeLineVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                treeNodeLineInfo<span class="token punctuation">.</span><span class="token function">setNodeIdFrom</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getNodeIdFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                treeNodeLineInfo<span class="token punctuation">.</span><span class="token function">setNodeIdTo</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getNodeIdTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                treeNodeLineInfo<span class="token punctuation">.</span><span class="token function">setRuleLimitType</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                treeNodeLineInfo<span class="token punctuation">.</span><span class="token function">setRuleLimitValue</span><span class="token punctuation">(</span>nodeLine<span class="token punctuation">.</span><span class="token function">getRuleLimitValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                treeNodeLineInfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>treeNodeLineInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将此节点的信息，尤其是此节点的两条连接子节点的线都保存进去</span>
        <span class="token class-name">TreeNodeVO</span> treeNodeInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNodeVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setTreeId</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setTreeNodeId</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setNodeType</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getNodeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setNodeValue</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setRuleKey</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getRuleKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setRuleDesc</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getRuleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        treeNodeInfo<span class="token punctuation">.</span><span class="token function">setTreeNodeLineInfoList</span><span class="token punctuation">(</span>treeNodeLineInfoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 保存每个节点</span>
        treeNodeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> treeNodeInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TreeRuleRich</span> treeRuleRich <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeRuleRich</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    treeRuleRich<span class="token punctuation">.</span><span class="token function">setTreeRoot</span><span class="token punctuation">(</span>treeRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    treeRuleRich<span class="token punctuation">.</span><span class="token function">setTreeNodeMap</span><span class="token punctuation">(</span>treeNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> treeRuleRich<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>需要理清的点</p> <ol><li>思考决策树对应的数据库表设计，分出哪些表，增加哪些字段</li> <li><strong>规则树的构建（难点）</strong></li> <li>规则的对比，如何将代码和数据库对应上——通过<img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1673274478765-c671fbb8-1743-419f-87cf-ddd31556fb49.png" alt="image.png"></li> <li>弄清楚对于单个节点、单个节点的两条子树的连线、整体的结果 是怎么做到的</li></ol> <hr> <p><a name="ibrWr"></a></p> <h2 id="十四、防腐层-门面接口封装和对象转换"><a href="#十四、防腐层-门面接口封装和对象转换" class="header-anchor">#</a> 十四、防腐层：门面接口封装和对象转换</h2> <p>到此为止，基本的接口已经开发完成，但都是一些独立的接口，只是上一层浅封装<br>现在使用门面接口封装，<strong><em>对外提供接口服务</em></strong></p> <ul><li><p><strong><em>DTO 层的作用更多是防污操作，如有些数据不想要，有些数据不想暴露，就需要进行一层转换操作</em></strong></p></li> <li><p><strong>尽量把系统提供者的模型转换为系统使用者的模型（而不引入中间第三者模型）</strong></p> <p><strong>上一节说的 规则过滤，要单独抽象出一个对外的接口，即先请求量化接口获的用户应该参与的活动，然后再拿着活动 ID 去抽奖</strong></p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LotteryActivityBooth</span> <span class="token keyword">implements</span> <span class="token class-name">ILotteryActivityBooth</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LotteryActivityBooth</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IActivityProcess</span> activityProcess<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IMapping</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DrawAwardVO</span><span class="token punctuation">,</span> <span class="token class-name">AwardDTO</span><span class="token punctuation">&gt;</span></span> awardMapping<span class="token punctuation">;</span>

    <span class="token comment">// 和下面相比少了过滤人群量化</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DrawRes</span> <span class="token function">doDraw</span><span class="token punctuation">(</span><span class="token class-name">DrawReq</span> drawReq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;抽奖，开始 uId：{} activityId：{}&quot;</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 1. 执行抽奖</span>
            <span class="token class-name">DrawProcessResult</span> drawProcessResult <span class="token operator">=</span> activityProcess<span class="token punctuation">.</span><span class="token function">doDrawProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawProcessReq</span><span class="token punctuation">(</span>drawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>drawProcessResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;抽奖，失败(抽奖过程异常) uId：{} activityId：{}&quot;</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span>drawProcessResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawProcessResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 2. 数据转换</span>
            <span class="token class-name">DrawAwardVO</span> drawAwardVO <span class="token operator">=</span> drawProcessResult<span class="token punctuation">.</span><span class="token function">getDrawAwardVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AwardDTO</span> awardDTO <span class="token operator">=</span> awardMapping<span class="token punctuation">.</span><span class="token function">sourceToTarget</span><span class="token punctuation">(</span>drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            awardDTO<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span>drawReq<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 3. 封装数据</span>
            <span class="token class-name">DrawRes</span> drawRes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            drawRes<span class="token punctuation">.</span><span class="token function">setAwardDTO</span><span class="token punctuation">(</span>awardDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;抽奖，完成 uId：{} activityId：{} drawRes：{}&quot;</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>drawRes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> drawRes<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;抽奖，失败 uId：{} activityId：{} reqJson：{}&quot;</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawReq<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>drawReq<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DrawRes</span> <span class="token function">doQuantificationDraw</span><span class="token punctuation">(</span><span class="token class-name">QuantificationDrawReq</span> quantificationDrawReq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，开始 uId：{} treeId：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 1. 执行规则引擎，获取用户可以参与的活动号</span>
            <span class="token class-name">RuleQuantificationCrowdResult</span> ruleQuantificationCrowdResult <span class="token operator">=</span> activityProcess<span class="token punctuation">.</span><span class="token function">doRuleQuantificationCrowd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DecisionMatterReq</span><span class="token punctuation">(</span>quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getValMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，失败(规则引擎执行异常) uId：{} treeId：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span>ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 2. 执行抽奖</span>
            <span class="token class-name">Long</span> activityId <span class="token operator">=</span> ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DrawProcessResult</span> drawProcessResult <span class="token operator">=</span> activityProcess<span class="token punctuation">.</span><span class="token function">doDrawProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawProcessReq</span><span class="token punctuation">(</span>quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>drawProcessResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，失败(抽奖过程异常) uId：{} treeId：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span>drawProcessResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawProcessResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 3. 数据转换</span>
            <span class="token class-name">DrawAwardVO</span> drawAwardVO <span class="token operator">=</span> drawProcessResult<span class="token punctuation">.</span><span class="token function">getDrawAwardVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AwardDTO</span> awardDTO <span class="token operator">=</span> awardMapping<span class="token punctuation">.</span><span class="token function">sourceToTarget</span><span class="token punctuation">(</span>drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            awardDTO<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 4. 封装数据</span>
            <span class="token class-name">DrawRes</span> drawRes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            drawRes<span class="token punctuation">.</span><span class="token function">setAwardDTO</span><span class="token punctuation">(</span>awardDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，完成 uId：{} treeId：{} drawRes：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>drawRes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> drawRes<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，失败 uId：{} treeId：{} reqJson：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>quantificationDrawReq<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><hr> <p><a name="Bkl2F"></a></p> <h2 id="十五、搭建-mq-kafka-环境"><a href="#十五、搭建-mq-kafka-环境" class="header-anchor">#</a> 十五、搭建 MQ + kafka 环境</h2> <p><strong>消息队列作用：</strong></p> <ul><li><strong>解耦</strong></li> <li><strong>异步</strong></li> <li><strong>削峰</strong></li></ul> <p><strong>为什么选择 Kafka？</strong></p> <ul><li><strong>零拷贝技术</strong> <ul><li><strong>RabbitMQ 也是支持零拷贝，但是它是基于</strong><code>**mmap**</code><strong>，因为它有延迟功能，所以必须内存要能操作到</strong></li> <li><strong>Kafka 零拷贝是基于</strong><code>**sendfile**</code><strong>， 即传递文件描述符，而不是传递文件本身，这个 IO 是可以忽略不记得</strong> <ul><li><code>**sendfile**</code><strong>机制类似百度网盘分享的连接，但是文件本身还在百度网盘存着</strong></li> <li><strong>RabbitMQ 不能这样，因为死信机制，如果文件没有在内存中，那么操作起来很不方便</strong></li> <li><strong>Kafka 在通过回调函数解决这个问题</strong></li></ul></li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">KafkaProducer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_TEST</span> <span class="token operator">=</span> <span class="token string">&quot;Hello-Kafka&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_GROUP</span> <span class="token operator">=</span> <span class="token string">&quot;test-consumer-group&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> obj2String <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;准备发送消息为：{}&quot;</span><span class="token punctuation">,</span> obj2String<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发送消息</span>
        <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">TOPIC_TEST</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

        future<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListenableFutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//发送失败的处理</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">TOPIC_TEST</span> <span class="token operator">+</span> <span class="token string">&quot; - 生产者 发送消息失败：&quot;</span> <span class="token operator">+</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stringObjectSendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//成功的处理</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">TOPIC_TEST</span> <span class="token operator">+</span> <span class="token string">&quot; - 生产者 发送消息成功：&quot;</span> <span class="token operator">+</span> stringObjectSendResult<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token class-name">KafkaProducer</span><span class="token punctuation">.</span><span class="token constant">TOPIC_TEST</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token class-name">KafkaProducer</span><span class="token punctuation">.</span><span class="token constant">TOPIC_GROUP</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">topicTest</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">,</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token class-name">KafkaHeaders</span><span class="token punctuation">.</span><span class="token constant">RECEIVED_TOPIC</span><span class="token punctuation">)</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> msg <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;topic_test 消费了： Topic:&quot;</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">&quot;,Message:&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 消费成功 返回ACK（默认1）</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">KafkaProducer</span> kafkaProducer<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

    <span class="token class-name">InvoiceVO</span> invoice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvoiceVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	invoice<span class="token punctuation">.</span><span class="token function">setuId</span><span class="token punctuation">(</span><span class="token string">&quot;fustack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryInvoice</span><span class="token punctuation">(</span>invoice<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><hr> <p><a name="KXd3e"></a></p> <h2 id="十六、使用-mq-解耦抽奖、发货流程"><a href="#十六、使用-mq-解耦抽奖、发货流程" class="header-anchor">#</a> 十六、使用 MQ 解耦抽奖、发货流程</h2> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677139035056-6d4be89c-cf91-4864-9f45-d5548b2638cb.png" alt="image.png"></p> <ul><li><strong><em>主要是：不用在抽完奖就更新发奖状态</em></strong> <a name="aeGYA"></a></li></ul> <h3 id="_1-流程说明"><a href="#_1-流程说明" class="header-anchor">#</a> 1. 流程说明</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677140263006-ece28cd0-eb05-4a27-9eb9-eeccf6e6689d.png" alt="image.png"></p> <ul><li>从用户发起抽奖到中奖后开始，就是 MQ 处理发奖的流程</li> <li>因为 MQ 消息的发送是不具备事务性的，也就是说你在发送 MQ 时可能会失败，哪怕成功率是 3 个 9 到 4 个 9，也会有一定的概率触发发送失败。所以我们<strong>在 MQ 发送完成后需要知道是否发送成功，进行库表状态更新（<strong>onFailure 设置状态为 2）</strong>，如果发送失败则需要使用 worker 来补偿 MQ 发送</strong>。（使用<code>xxl-job</code></li> <li>最后 MQ 发送完成到消费，也是可能有失败的，比如处理失败、更新库表失败等，但无论是什么失败都需要保证 MQ 进行重试处理。而保证 MQ 消息重试的前提就是服务的幂等性，否则你在重试的过程中就造成了流程异常，比如更新次数多了、数据库插入多了、给用户发奖多了等等，尤其是发生资损是更可怕的。
<a name="oJrZW"></a></li></ul> <h3 id="_2-mq-服务"><a href="#_2-mq-服务" class="header-anchor">#</a> 2. MQ 服务</h3> <p>关于 MQ 的使用，无论是 Kafka 还是 RocketMQ，基本方式都是类似的，一个生产消息，一个监听消息，只不过在一些符合各自业务场景下，做了细分的优化，但这并不会影响你的使用。
<a name="hQi9c"></a></p> <h4 id="_2-1-生产消息"><a href="#_2-1-生产消息" class="header-anchor">#</a> 2.1 生产消息</h4> <ul><li>我们会把所有的生产消息都放到 KafkaProducer 中，并对外提供一个可以发送 MQ 消息的方法。</li> <li>因为我们配置的类型转换为 StringDeserializer 所以发送消息的方式是 JSON 字符串，当然这个编解码器是可以重写的，满足你发送其他类型的数据。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">KafkaProducer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * MQ主题：中奖发货单
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TOPIC_INVOICE</span> <span class="token operator">=</span> <span class="token string">&quot;lottery_invoice&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 发送中奖物品发货单消息
     *
     * @param invoice 发货单
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendLotteryInvoice</span><span class="token punctuation">(</span><span class="token class-name">InvoiceVO</span> invoice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> objJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>invoice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送MQ消息 topic：{} bizId：{} message：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_INVOICE</span><span class="token punctuation">,</span> invoice<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> objJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">TOPIC_INVOICE</span><span class="token punctuation">,</span> objJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><a name="TPyWp"></a></p> <h4 id="_2-2-消费消息"><a href="#_2-2-消费消息" class="header-anchor">#</a> 2.2 消费消息</h4> <ul><li>每一个 MQ 消息的消费都会有一个对应的 XxxListener 来处理消息体，如果你使用一些其他的 MQ 可能还会看到一些抽象类来处理 MQ 消息集合。</li> <li>在这个 LotteryInvoiceListener 消息监听类中，主要就是**<em>通过消息中的发奖类型获取到对应的奖品发货工厂，处理奖品的发送操作</em>**。</li> <li>在奖品发送操作中，已经补全了 DistributionBase#updateUserAwardState 更新奖品发送状态的操作。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LotteryInvoiceListener</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LotteryInvoiceListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">DistributionGoodsFactory</span> distributionGoodsFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">&quot;lottery_invoice&quot;</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">&quot;lottery&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> ack<span class="token punctuation">,</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token class-name">KafkaHeaders</span><span class="token punctuation">.</span><span class="token constant">RECEIVED_TOPIC</span><span class="token punctuation">)</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 判断消息是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>message<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. 处理 MQ 消息</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1. 转化对象（或者你也可以重写Serializer&lt;T&gt;）</span>
            <span class="token class-name">InvoiceVO</span> invoiceVO <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InvoiceVO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 2. 获取发送奖品工厂，执行发奖</span>
            <span class="token class-name">IDistributionGoods</span> distributionGoodsService <span class="token operator">=</span> distributionGoodsFactory<span class="token punctuation">.</span><span class="token function">getDistributionGoodsService</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getAwardType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DistributionRes</span> distributionRes <span class="token operator">=</span> distributionGoodsService<span class="token punctuation">.</span><span class="token function">doDistribution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GoodsReq</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getAwardId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getAwardName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getAwardContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>AwardState</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>distributionRes<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> distributionRes<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 3. 打印日志</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消费MQ消息，完成 topic：{} bizId：{} 发奖结果：{}&quot;</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>distributionRes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 4. 消息消费完成</span>
            ack<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发奖环节失败，消息重试。所有到环节，发货、更新库，都需要保证幂等。</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;消费MQ消息，失败 topic：{} message：{}&quot;</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>因为奖品发送不需要实时</p> <p><a name="XS0Jp"></a></p> <h3 id="_3-抽奖流程解耦"><a href="#_3-抽奖流程解耦" class="header-anchor">#</a> 3. 抽奖流程解耦</h3> <ul><li><p>将 MQ 添加到抽奖流程中</p></li> <li><p>在 ActivityProcessImpl#doDrawProcess 方法中，主要补全的就是关于 MQ 的处理，这里我们会调动 kafkaProducer.sendLotteryInvoice 发送一个中奖结果的发货单。</p> <ul><li><strong>发送 MQ 消息，第一步领取活动就扣取了 Redis 的库存，在这一步进行 MySQL 数据同步，所以后面有可能 Redis 不成功，但是 MySQL 已经落库了 ⭐️⭐️⭐️</strong></li></ul></li> <li><p>消息发送完毕后进行回调处理，更新数据库中 MQ 发送的状态，如果有 MQ 发送失败则更新数据库 mq_state = 2 <strong>这里还有可能在更新库表状态的时候失败</strong>，但没关系这些都会被 worker 补偿处理掉，一种是发送 MQ 失败，另外一种是 MQ 状态为 0 但很久都没有发送 MQ 那么也可以触发发送。</p> <p>查询<strong>发送 MQ 失败（2）<strong>和</strong>超时 30 分钟（0）</strong>，未发送 MQ 的数据:<br> // 消息发送状态（0 未发送、1 发送成功、2 发送失败）<br> // 表 user_strategy_export：<strong>WHERE mq_state = 2 OR ( mq_state = 0 AND now() - create_time &gt; 1800000 )</strong></p></li> <li><p>现在从用户领取活动、执行抽奖、结果落库，到 发送 MQ 处理后续发奖的流程就解耦了，<strong>因为用户只需要知道自己中奖了，但发奖到货是可以等待的</strong>，毕竟发送虚拟商品的等待时间并不会很长，而实物商品走物流就更可以接收了。所以对于这样的流程进行解耦是非常有必要的，否则<em>你的程序逻辑会让用户在界面等待更久的时间</em>。</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DrawProcessResult</span> <span class="token function">doDrawProcess</span><span class="token punctuation">(</span><span class="token class-name">DrawProcessReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 领取活动</span>

    <span class="token comment">// 2. 执行抽奖</span>

    <span class="token comment">// 3. 结果落库</span>

    <span class="token comment">// 4. 发送MQ，触发发奖流程</span>
    <span class="token class-name">InvoiceVO</span> invoiceVO <span class="token operator">=</span> <span class="token function">buildInvoiceVO</span><span class="token punctuation">(</span>drawOrderVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryInvoice</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListenableFutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stringObjectSendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.1 MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span>
                <span class="token comment">//  在这里是更新状态，而插入这一条是第三步结果落库中</span>
            activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span><span class="token constant">COMPLETE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.2 MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span>
            activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 返回结果</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><a name="aMP60"></a></p> <h3 id="_4-流程图"><a href="#_4-流程图" class="header-anchor">#</a> 4. 流程图</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677139616225-69182c97-2acd-485a-96de-1e1fd0b82118.png" alt="image.png"></p> <hr> <p><a name="Opsjx"></a></p> <h2 id="十七、引入xxl-job处理活动状态扫描"><a href="#十七、引入xxl-job处理活动状态扫描" class="header-anchor">#</a> 十七、引入<code>xxl-job</code>处理活动状态扫描</h2> <blockquote><p>XXL-JOB 是一个分布式任务调度平台</p></blockquote> <p>xxl-job 用来充当 worker，扫描抽奖活动状态，把审核通过的活动扫描为活动中，把已过期活动中的状态扫描为关闭。后续章节我们还会使用分布式任务调度系统解决其他场景问题。
<a name="SVdpO"></a></p> <h3 id="_1-xxl-job-基础配置"><a href="#_1-xxl-job-基础配置" class="header-anchor">#</a> 1. xxl-job 基础配置</h3> <ol><li>引入 pom</li> <li>配置 yml</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>## xxl<span class="token operator">-</span>job
## 官网：https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>xuxueli<span class="token operator">/</span>xxl<span class="token operator">-</span>job<span class="token operator">/</span>
## 地址：http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">7397</span><span class="token operator">/</span>xxl<span class="token operator">-</span>job<span class="token operator">-</span>admin 【需要先启动 xxl<span class="token operator">-</span>job】
## 账号：admin
## 密码：<span class="token number">123456</span>
xxl<span class="token operator">:</span>
  job<span class="token operator">:</span>
    admin<span class="token operator">:</span>
      addresses<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7397</span><span class="token operator">/</span>xxl<span class="token operator">-</span>job<span class="token operator">-</span>admin
    executor<span class="token operator">:</span>
      address<span class="token operator">:</span>
      appname<span class="token operator">:</span> lottery<span class="token operator">-</span>job
      ip<span class="token operator">:</span>
      port<span class="token operator">:</span> <span class="token number">9999</span>
      logpath<span class="token operator">:</span> <span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>fuzhengwei<span class="token operator">/</span>itstack<span class="token operator">/</span>data<span class="token operator">/</span>applogs<span class="token operator">/</span>xxl<span class="token operator">-</span>job<span class="token operator">/</span>jobhandler
      logretentiondays<span class="token operator">:</span> <span class="token number">50</span>
    accessToken<span class="token operator">:</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><a name="yy1m1"></a></p> <h3 id="_2-初始化任务执行器"><a href="#_2-初始化任务执行器" class="header-anchor">#</a> 2. 初始化任务执行器</h3> <p>这里需要启动一个任务执行器，通过配置 @Bean 对象的方式交给 Spring 进行管理。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description: XXL-JOB 配置
 * @author: 小傅哥，微信：fustack
 * @date: 2021/11/6
 * @github: https://github.com/fuzhengwei
 * @Copyright: 公众号：bugstack虫洞栈 | 博客：https://bugstack.cn - 沉淀、分享、成长，让自己和他人都能有所收获！
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LotteryXxlJobConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LotteryXxlJobConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.admin.addresses}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> adminAddresses<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.accessToken}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.executor.appname}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appname<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.executor.address}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.executor.ip}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.executor.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.executor.logpath}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxl.job.executor.logretentiondays}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> logRetentionDays<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">XxlJobSpringExecutor</span> <span class="token function">xxlJobExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">XxlJobSpringExecutor</span> xxlJobSpringExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XxlJobSpringExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAdminAddresses</span><span class="token punctuation">(</span>adminAddresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAppname</span><span class="token punctuation">(</span>appname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogPath</span><span class="token punctuation">(</span>logPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogRetentionDays</span><span class="token punctuation">(</span>logRetentionDays<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> xxlJobSpringExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**********************************************************************************************
     * 针对多网卡、容器内部署等情况，可借助 &quot;spring-cloud-commons&quot; 提供的 &quot;InetUtils&quot; 组件灵活定制注册IP；
     *
     *      1、引入依赖：
     *          &lt;dependency&gt;
     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;
     *             &lt;version&gt;${version}&lt;/version&gt;
     *         &lt;/dependency&gt;
     *
     *      2、配置文件，或者容器启动变量
     *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'
     *
     *      3、获取IP
     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();
     **********************************************************************************************/</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><a name="rKPnD"></a></p> <h3 id="_3-开发活动扫描任务"><a href="#_3-开发活动扫描任务" class="header-anchor">#</a> 3. 开发活动扫描任务</h3> <p><strong>在任务扫描中，主要把已经审核通过的活动和已过期的活动中状态进行变更操作；</strong></p> <ul><li><strong>审核通过 -&gt; 扫描为活动中</strong></li> <li><strong>活动中已过期时间 -&gt; 扫描为活动关闭</strong></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description: 抽奖业务，任务配置
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LotteryXxlJob</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LotteryXxlJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IActivityDeploy</span> activityDeploy<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IStateHandler</span> stateHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;lotteryActivityStateJobHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lotteryActivityStateJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描活动状态 Begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityVO</span><span class="token punctuation">&gt;</span></span> activityVOList <span class="token operator">=</span> activityDeploy<span class="token punctuation">.</span><span class="token function">scanToDoActivityList</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activityVOList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描活动状态 End 暂无符合需要扫描的活动列表&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>activityVOList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ActivityVO</span> activityVO <span class="token operator">:</span> activityVOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Integer</span> state <span class="token operator">=</span> activityVO<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 活动状态为审核通过，在临近活动开启时间前，审核活动为活动中。在使用活动的时候，需要依照活动状态核时间两个字段进行判断和使用。</span>
                    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                        <span class="token class-name">Result</span> state4Result <span class="token operator">=</span> stateHandler<span class="token punctuation">.</span><span class="token function">doing</span><span class="token punctuation">(</span>activityVO<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">PASS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描活动状态为活动中 结果：{} activityId：{} activityName：{} creator：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>state4Result<span class="token punctuation">)</span><span class="token punctuation">,</span> activityVO<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityVO<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityVO<span class="token punctuation">.</span><span class="token function">getCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment">// 扫描时间已过期的活动，从活动中状态变更为关闭状态【这里也可以细化为2个任务来处理，也可以把时间判断放到数据库中操作】</span>
                    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
                        <span class="token comment">// 看是否过期了</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>activityVO<span class="token punctuation">.</span><span class="token function">getEndDateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token class-name">Result</span> state5Result <span class="token operator">=</span> stateHandler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>activityVO<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ActivityState</span><span class="token punctuation">.</span><span class="token constant">DOING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描活动状态为关闭 结果：{} activityId：{} activityName：{} creator：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>state5Result<span class="token punctuation">)</span><span class="token punctuation">,</span> activityVO<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityVO<span class="token punctuation">.</span><span class="token function">getActivityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityVO<span class="token punctuation">.</span><span class="token function">getCreator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取集合中最后一条记录，继续扫描后面10条记录</span>
            <span class="token class-name">ActivityVO</span> activityVO <span class="token operator">=</span> activityVOList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activityVOList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityVOList <span class="token operator">=</span> activityDeploy<span class="token punctuation">.</span><span class="token function">scanToDoActivityList</span><span class="token punctuation">(</span>activityVO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描活动状态 End&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p><a name="JXJ3P"></a></p> <h3 id="_4-在-xxl-job-管理界面配置任务调度执行器"><a href="#_4-在-xxl-job-管理界面配置任务调度执行器" class="header-anchor">#</a> 4. 在 xxl-job 管理界面配置任务调度执行器</h3> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677144599180-f4d28131-fc2d-41a0-a0dd-4e2387a827df.png" alt="image.png"> <a name="MdtnC"></a></p> <h3 id="_5-配置任务"><a href="#_5-配置任务" class="header-anchor">#</a> 5. 配置任务</h3> <p>这里我们把已经开发了的任务 <code>LotteryXxlJob#lotteryActivityStateJobHandler</code> 配置到任务调度中心，如下：<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677144622468-9736ed2f-0c4d-484c-ac7a-43ad3a931201.png" alt="image.png"></p> <hr> <p><a name="xEJZY"></a></p> <h2 id="十八、扫描库表补偿发货单-mq-消息"><a href="#十八、扫描库表补偿发货单-mq-消息" class="header-anchor">#</a> 十八、扫描库表补偿发货单 MQ 消息</h2> <p>分布式任务调度，扫描抽奖发货单消息状态，对于未发送 MQ 或者发送失败的 MQ，进行补偿发送处理<br>在开始参与活动时，先看一下<code>user_take_activity</code>有没有此用户参与的还没用的（状态为 0）
<a name="C7acH"></a></p> <h3 id="_1-任务流程"><a href="#_1-任务流程" class="header-anchor">#</a> 1. 任务流程</h3> <ul><li>我们的任务流程，完成的就是整个抽奖活动中，关于中奖结果落库后，进行 MQ 后。出现问题时，进行补偿消息发送处理的部分。</li> <li>在 MQ 消息补偿的过程中，会把发送失败的消息和迟迟没有发送的消息，都进行补偿，已保障全流程的可靠性。</li></ul> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677154622285-c6010daa-ae64-413e-b215-a9560b07de4e.png" alt="image.png"> <a name="kQAcP"></a></p> <h3 id="_2-功能实现"><a href="#_2-功能实现" class="header-anchor">#</a> 2. 功能实现</h3> <p><a name="D3CFQ"></a></p> <h4 id="_2-1-路由组件提供必要方法"><a href="#_2-1-路由组件提供必要方法" class="header-anchor">#</a> 2.1 路由组件提供必要方法</h4> <p>因为要扫描所有的库和库表，所以要提供获得分库、分表的数量 用来 for 循环</p> <ul><li>新增加方法：setDBKey、setTBKey、dbCount、tbCount</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> dbIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setDBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%02d&quot;</span><span class="token punctuation">,</span> dbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> tbIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">setTBKey</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%03d&quot;</span><span class="token punctuation">,</span> tbIdx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">dbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getDbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">tbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> dbRouterConfig<span class="token punctuation">.</span><span class="token function">getTbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">clearDBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DBContextHolder</span><span class="token punctuation">.</span><span class="token function">clearTBKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><a name="SeePr"></a></p> <h4 id="_2-2-消息补偿任务"><a href="#_2-2-消息补偿任务" class="header-anchor">#</a> 2.2 消息补偿任务</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;lotteryOrderMQStateJobHandler&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lotteryOrderMQStateJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 验证参数</span>
    <span class="token class-name">String</span> jobParam <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getJobParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> jobParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 错误 params is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取分布式任务配置参数信息 参数配置格式：1,2,3 也可以是指定扫描一个，也可以配置多个库，按照部署的任务集群进行数量配置，均摊分别扫描效率更高</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> jobParam<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 开始 params：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 结束 params is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取分库分表配置下的分表数</span>
    <span class="token keyword">int</span> tbCount <span class="token operator">=</span> dbRouter<span class="token punctuation">.</span><span class="token function">tbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 循环获取指定扫描库</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> param <span class="token operator">:</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取当前任务扫描的指定分库</span>
        <span class="token keyword">int</span> dbCount <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断配置指定扫描库数，是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dbCount <span class="token operator">&gt;</span> dbRouter<span class="token punctuation">.</span><span class="token function">dbCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 结束 dbCount not exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 循环扫描对应表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tbCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 扫描库表数据 ⭐️⭐️⭐️⭐️⭐️</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InvoiceVO</span><span class="token punctuation">&gt;</span></span> invoiceVOList <span class="token operator">=</span> activityPartake<span class="token punctuation">.</span><span class="token function">scanInvoiceMqState</span><span class="token punctuation">(</span>dbCount<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 扫描库：{} 扫描表：{} 扫描数：{}&quot;</span><span class="token punctuation">,</span> dbCount<span class="token punctuation">,</span> i<span class="token punctuation">,</span> invoiceVOList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 补偿 MQ 消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InvoiceVO</span> invoiceVO <span class="token operator">:</span> invoiceVOList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryInvoice</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
                future<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListenableFutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stringObjectSendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span>
                        activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span>
                        activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扫描用户抽奖奖品发放MQ状态[Table = 2*4] 完成 param：{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>上面五 ⭐️ 处，是扫描发货单 MQ 状态，把未发送 MQ 的单子扫描出来，做补偿</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InvoiceVO</span><span class="token punctuation">&gt;</span></span> <span class="token function">scanInvoiceMqState</span><span class="token punctuation">(</span><span class="token keyword">int</span> dbCount<span class="token punctuation">,</span> <span class="token keyword">int</span> tbCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置路由</span>
        dbRouter<span class="token punctuation">.</span><span class="token function">setDBKey</span><span class="token punctuation">(</span>dbCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dbRouter<span class="token punctuation">.</span><span class="token function">setTBKey</span><span class="token punctuation">(</span>tbCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询数据</span>
        <span class="token keyword">return</span> userTakeActivityRepository<span class="token punctuation">.</span><span class="token function">scanInvoiceMqState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        dbRouter<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>下图是调用的 mapper SQL，查询 state=2 或者超时的<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677155235238-43dcdbaa-2b3e-4333-b1b0-64d4d19ffd8c.png" alt="image.png"> <a name="JJti8"></a></p> <h3 id="_3-xxl-job-任务配置"><a href="#_3-xxl-job-任务配置" class="header-anchor">#</a> 3. Xxl-job 任务配置</h3> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/300264/1677155308091-e023649c-7d66-4f04-b94e-457cd1d17424.png#averageHue=%23eeeeed&amp;clientId=u753df5a4-f7b8-4&amp;from=paste&amp;height=475&amp;id=ue01432f8&amp;name=image.png&amp;originHeight=950&amp;originWidth=1858&amp;originalType=binary&amp;ratio=2&amp;rotation=0&amp;showTitle=false&amp;size=657671&amp;status=done&amp;style=none&amp;taskId=u99f7bd81-b7e2-4967-af22-1e1ec71b419&amp;title=&amp;width=929" alt="image.png"><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677155418597-c2809fcd-d74b-46db-bb9f-505224e609ac.png" alt="image.png" title="job任务参数"></p> <hr> <p><a name="M8BrJ"></a></p> <h2 id="十九、设计滑动库存分布式锁处理活动秒杀-防止超卖"><a href="#十九、设计滑动库存分布式锁处理活动秒杀-防止超卖" class="header-anchor">#</a> 十九、设计滑动库存分布式锁处理活动秒杀：防止超卖</h2> <p>用的什么 Redis：<br>Spring Data Redis，底层是封装了 jedis</p> <ul><li>属于秒杀场景，目的是防止超卖</li> <li>将原来加载活动号上的锁（粗粒度）如 100001、100002，改加到活动库存（细粒度）：以滑动库存剩余编号的方式进行加锁，例如 100001_1、100001_2、100001_3</li> <li>增加缓存扣减库存后，发送 MQ 消息进行异步更新数据库中活动库存，做最终数据一致性处理。<em>这一部分如果你的系统并发体量较大，还需要把 MQ 的数据不要直接对库更新，而是更新到缓存中，再由任务最阶段同步，以此减少对数据库表的操作</em> <a name="D8bpv"></a></li></ul> <h3 id="_1-扣减流程"><a href="#_1-扣减流程" class="header-anchor">#</a> 1. 扣减流程</h3> <p>活动领取完成后，其实<strong>这个时候只是把缓存的库存扣掉了，<s>但数据库中的库存并没有扣减（Redis 扣除前，就已经更新 MySQL 库存了）</s>，所以我们需要发送一个 MQ 消息，这个消息是执行发奖，发奖成功的回调 更新数据库表 user_strategy_export.mq_state = 1</strong>。因为 MQ 可以消峰因此在降低 MQ 分片的情况下，消费效率有所下降，并不会对数据库造成压力，保证最终数据一致性即可。<em>但也有例外，所以我们提到可以使用定时任务来更新数据库库存</em><br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677231941805-f4b90f02-59fb-452e-81ad-3d58f2b71af7.png" alt="image.png"> <a name="m7f4S"></a></p> <h3 id="_2-功能开发"><a href="#_2-功能开发" class="header-anchor">#</a> 2. 功能开发</h3> <p><a name="y5jl8"></a></p> <h4 id="_2-1-滑动库存锁设计"><a href="#_2-1-滑动库存锁设计" class="header-anchor">#</a> 2.1 滑动库存锁设计</h4> <p>原来如果只加到活动号上，则粒度太大，比如库存还有 100，用户 A 先获得了这个活动，那么之后的用户都不能再获得了，直到 A 释放<br>现在改加到获得库存上，即对于某个具体的库存加一把锁：activity_100、activity_99 这样粒度就更小了。**「活动 ID+库存扣减后的值」作为加锁的 key **
<a name="e94VU"></a></p> <h3 id="滑动库存初始化"><a href="#滑动库存初始化" class="header-anchor">#</a> 滑动库存初始化</h3> <p>在管理员创建完活动后，进行 Redis 的初始化</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityVO</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Activity</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Activity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    activityDao<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置活动库存 KEY</span>
    redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>RedisKey</span><span class="token punctuation">.</span><span class="token function">KEY_LOTTERY_ACTIVITY_STOCK_COUNT</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// KEY_LOTTERY_ACTIVITY_STOCK_COUNT(id,0) 会调用下面这个方法：</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">KEY_LOTTERY_ACTIVITY_STOCK_COUNT</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">LOTTERY_ACTIVITY_STOCK_COUNT</span> <span class="token operator">+</span> activityId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 然后调将此 key设为0  如：LOTTERY_ACTIVITY_STOCK_COUNT_10001</span>
redisUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">LOTTERY_ACTIVITY_STOCK_COUNT_10001</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><a name="k1vS5"></a></p> <h3 id="_2-2-库存扣减操作"><a href="#_2-2-库存扣减操作" class="header-anchor">#</a> 2.2 库存扣减操作</h3> <p>注意生成的是两个 key：</p> <ol><li>一个是每次来调用获得 先获得当前的库存：redis.get(<code>**KEY_LOTTERY_ACTIVITY_STOCK_COUNT_10001**</code>, <strong>40</strong>) (40 是已经消耗的）</li> <li>然后对比 MySQL 内的库存，如果小于则继续，否则库存不足</li> <li>二是生成 已用的库存 Key <code>**KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN_41**</code></li> <li>然后<strong>对这个 token 加上分布式锁</strong>，注意有时间 350L（毫秒）</li> <li>最后（抽奖彻底执行完毕），将这个 <code>**KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN_41**</code>** 恢复，但是 <strong><code>**KEY_LOTTERY_ACTIVITY_STOCK_COUNT_10001**</code></strong> 不恢复**</li></ol> <blockquote><p><code>**stockUsedCount**</code><strong>代表的是已消耗的库存，而不是剩余的</strong></p></blockquote> <ul><li>代码中的注释就是整个操作流程，创建 Key、占用库存、判断库存、<strong>以占用库存的编号做为加锁 key</strong>、调用 setNx 加一个分布式锁，最终完成整个秒杀扣减库存的动作。</li> <li>这里还有一些其他的实现方式，例如：lua 脚本、zk、jvm 层，<strong>mysql（实现分布式锁</strong>：阿里搜索引擎面试）都可以处理，但经过验证 lua 脚本会有一定的耗时，并发较高时会有问题。</li> <li>秒杀的设计原则是保证不超卖，但不一定保证 100 个库存完全消耗掉，因为可能会有一些锁失败的情况，如用户 A 获得了<code>100001_90</code>用户 B 获得了<code>100001_91</code>，如果用户 A 释放锁失败没有把 90 再减回去，那么 90 这个库存就不能再用了</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">StockResult</span> <span class="token function">subtractionActivityStockByRedis</span><span class="token punctuation">(</span><span class="token class-name">String</span> uId<span class="token punctuation">,</span> <span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> stockCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要传入MySQL的实际库存数，优化成在Redis内存储的一个常量</span>

    <span class="token comment">//  1. 获取抽奖活动库存 Key</span>
    <span class="token class-name">String</span> stockKey <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RedisKey</span><span class="token punctuation">.</span><span class="token function">KEY_LOTTERY_ACTIVITY_STOCK_COUNT</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 扣减库存，目前占用库存数</span>
    <span class="token comment">// 采用的是增加式，代表「已消耗库存」 stockCount 为止</span>
    <span class="token class-name">Integer</span> stockUsedCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> redisUtil<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span>stockKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 超出库存判断，进行恢复原始库存</span>
    <span class="token comment">// 这个恢复库存是恢复的库存，而不是释放锁</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stockUsedCount <span class="token operator">&gt;</span> stockCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span>stockKey<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StockResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">OUT_OF_STOCK</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">OUT_OF_STOCK</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 以活动库存占用编号，生成对应加锁Key，细化锁的颗粒度</span>
    <span class="token class-name">String</span> stockTokenKey <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RedisKey</span><span class="token punctuation">.</span><span class="token function">KEY_LOTTERY_ACTIVITY_STOCK_COUNT_TOKEN</span><span class="token punctuation">(</span>activityId<span class="token punctuation">,</span> stockUsedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 使用 Redis.setNx 加一个分布式锁</span>
    <span class="token keyword">boolean</span> lockToken <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">setNx</span><span class="token punctuation">(</span>stockTokenKey<span class="token punctuation">,</span> <span class="token number">350L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lockToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;抽奖活动{}用户秒杀{}扣减库存，分布式锁失败：{}&quot;</span><span class="token punctuation">,</span> activityId<span class="token punctuation">,</span> uId<span class="token punctuation">,</span> stockTokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StockResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">ERR_TOKEN</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">ERR_TOKEN</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StockResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockTokenKey<span class="token punctuation">,</span> stockCount <span class="token operator">-</span> stockUsedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><a name="Qp2j1"></a></p> <h3 id="_2-2-并发锁删除处理"><a href="#_2-2-并发锁删除处理" class="header-anchor">#</a> 2.2 并发锁删除处理</h3> <p>删除滑动库存锁分两种情况：</p> <ol><li>一种是落库没成功，那么需要把库存再还回去
<ol><li>注意是非原子的，没必要原子性，保证不超卖即可</li></ol></li> <li>第二种就是落库成功了，就不能还库存了，只释放掉滑动库存锁即可（不释放对数据没影响，影响是性能）</li></ol> <blockquote><p>两种情况都需要释放掉滑动库存锁</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recoverActivityCacheStockByRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> activityId<span class="token punctuation">,</span> <span class="token class-name">String</span> tokenKey<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 1.获取抽奖活动库存 Key</span>
        <span class="token class-name">String</span> stockkey <span class="token operator">=</span> <span class="token class-name">Constants<span class="token punctuation">.</span>RedisKey</span><span class="token punctuation">.</span><span class="token function">KEY_LOTTERY_ACTIVITY_STOCK_COUNT</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 回滾库存操作，此操作非原子性的</span>
        redisUtil<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span>stockkey<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 删除分布式锁 Key</span>
    redisUtil<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>tokenKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><a name="GzKxO"></a></p> <h3 id="_2-3-活动秒杀流程处理"><a href="#_2-3-活动秒杀流程处理" class="header-anchor">#</a> 2.3 活动秒杀流程处理</h3> <p><code>BaseActivityPartake#doPartake</code><br>扣减库存后，在各个以下的流程节点中，如果有流程失败则进行缓存库存的恢复操作。<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677233188891-3ae4d296-5e1c-4051-8348-50b1992ff97e.png" alt="image.png"> <a name="a1cBn"></a></p> <h3 id="_2-4-发送-mq-消息-处理数据一致性-⭐️⭐️⭐️"><a href="#_2-4-发送-mq-消息-处理数据一致性-⭐️⭐️⭐️" class="header-anchor">#</a> 2.4 发送 MQ 消息，处理数据一致性 ⭐️⭐️⭐️</h3> <p>由于我们使用 Redis 代替数据库库存，那么在缓存的库存处理后，还需要把数据库中的库存处理为和缓存一致，这样在后续运营这部分数据时才能保证一定的运营可靠性。<br><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677233875893-2c9008ca-2de6-47fa-94ed-6cb7b4aba763.png" alt="image.png"> <a name="EdYlK"></a></p> <h3 id="_2-5-活动领取记录-mq-消费"><a href="#_2-5-活动领取记录-mq-消费" class="header-anchor">#</a> 2.5 活动领取记录 MQ 消费</h3> <ul><li>消费 MQ 消息的流程就比较简单了，接收到 MQ 进行更新数据库处理即可。不过我们这里<strong>更新数据库并不是直接对数据库进行库存扣减操作，而是把从缓存拿到的库存最新镜像更新到数据库中</strong>。它的 SQL = <code>UPDATE activity SET stock_surplus_count = #{stockSurplusCount} WHERE activity_id = #{activityId} AND stock_surplus_count &gt; #{stockSurplusCount}</code></li> <li>更新数据库库存【实际场景业务体量较大，可能也会由于 MQ 消费引起并发，对数据库产生压力，所以如果并发量较大，可以把库存记录缓存中，并使用定时任务进行处理缓存和数据库库存同步，减少对数据库的操作次数】</li></ul> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1677234214833-09f7e3af-e0a1-48a1-b2f3-42e874a29495.png" alt="image.png"></p> <hr> <p><a name="uYj12"></a></p> <h2 id="个人优化"><a href="#个人优化" class="header-anchor">#</a> 个人优化</h2> <p>面试的时候，要说一部分是看着写的，一部分是自己想的优化的：</p> <ul><li>最开始数据都存在 MySQL，优化后存入到 Redis
<ul><li>即一开始库存是直接扣的 MySQL，后续优化成 Redis</li> <li>然后就解决缓存击穿、传统、雪崩</li></ul></li> <li>加了些什么？校验器，最开始只有性别，加了个年龄</li></ul> <hr> <p><a name="Zrhof"></a></p> <h2 id="末、完整的流程"><a href="#末、完整的流程" class="header-anchor">#</a> 末、完整的流程</h2> <p><img src="https://raw.githubusercontent.com/Twany/picGoStore/master/1678771557494-20dcaf13-2808-45e2-a5c0-63364a91ac10.png" alt="process.png"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">DrawProcessResult</span> <span class="token function">doDrawProcess</span><span class="token punctuation">(</span><span class="token class-name">DrawProcessReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 领取活动</span>
    <span class="token class-name">PartakeResult</span> partakeResult <span class="token operator">=</span> activityPartake<span class="token punctuation">.</span><span class="token function">doPartake</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PartakeReq</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">NOT_CONSUMED_TAKE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partakeResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 首次成功领取活动，发送 MQ 消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ActivityPartakeRecordVO</span> activityPartakeRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityPartakeRecordVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setuId</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activityPartakeRecord<span class="token punctuation">.</span><span class="token function">setStockSurplusCount</span><span class="token punctuation">(</span>partakeResult<span class="token punctuation">.</span><span class="token function">getStockSurplusCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送 MQ 消息</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryActivityPartakeRecord</span><span class="token punctuation">(</span>activityPartakeRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Long</span> strategyId <span class="token operator">=</span> partakeResult<span class="token punctuation">.</span><span class="token function">getStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> takeId <span class="token operator">=</span> partakeResult<span class="token punctuation">.</span><span class="token function">getTakeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 执行抽奖</span>
    <span class="token class-name">DrawResult</span> drawResult <span class="token operator">=</span> drawExec<span class="token punctuation">.</span><span class="token function">doDrawExec</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawReq</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> strategyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>DrawState</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>drawResult<span class="token punctuation">.</span><span class="token function">getDrawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">LOSING_DRAW</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">LOSING_DRAW</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DrawAwardVO</span> drawAwardVO <span class="token operator">=</span> drawResult<span class="token punctuation">.</span><span class="token function">getDrawAwardInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 结果落库</span>
    <span class="token class-name">DrawOrderVO</span> drawOrderVO <span class="token operator">=</span> <span class="token function">buildDrawOrderVO</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> strategyId<span class="token punctuation">,</span> takeId<span class="token punctuation">,</span> drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Result</span> recordResult <span class="token operator">=</span> activityPartake<span class="token punctuation">.</span><span class="token function">recordDrawOrder</span><span class="token punctuation">(</span>drawOrderVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>recordResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span>recordResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> recordResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 发送MQ，触发发奖流程</span>
    <span class="token class-name">InvoiceVO</span> invoiceVO <span class="token operator">=</span> <span class="token function">buildInvoiceVO</span><span class="token punctuation">(</span>drawOrderVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> kafkaProducer<span class="token punctuation">.</span><span class="token function">sendLotteryInvoice</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    future<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ListenableFutureCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SendResult</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stringObjectSendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.1 MQ 消息发送完成，更新数据库表 user_strategy_export.mq_state = 1</span>
            activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span><span class="token constant">COMPLETE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.2 MQ 消息发送失败，更新数据库表 user_strategy_export.mq_state = 2 【等待定时任务扫码补偿MQ消息】</span>
            activityPartake<span class="token punctuation">.</span><span class="token function">updateInvoiceMqState</span><span class="token punctuation">(</span>invoiceVO<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invoiceVO<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>MQState</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6. 返回结果</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawProcessResult</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>添加了量化的步骤之后：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">DrawRes</span> <span class="token function">doQuantificationDraw</span><span class="token punctuation">(</span><span class="token class-name">QuantificationDrawReq</span> quantificationDrawReq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，开始 uId：{} treeId：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 执行规则引擎，获取用户可以参与的活动号</span>
        <span class="token comment">// 相比上面，就是多了这一步</span>
        <span class="token class-name">RuleQuantificationCrowdResult</span> ruleQuantificationCrowdResult <span class="token operator">=</span> activityProcess<span class="token punctuation">.</span><span class="token function">doRuleQuantificationCrowd</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DecisionMatterReq</span><span class="token punctuation">(</span>quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getValMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，失败(规则引擎执行异常) uId：{} treeId：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span>ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. 执行抽奖</span>
        <span class="token class-name">Long</span> activityId <span class="token operator">=</span> ruleQuantificationCrowdResult<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用的是上面的doDrawProcess()</span>
        <span class="token class-name">DrawProcessResult</span> drawProcessResult <span class="token operator">=</span> activityProcess<span class="token punctuation">.</span><span class="token function">doDrawProcess</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DrawProcessReq</span><span class="token punctuation">(</span>quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activityId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>drawProcessResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，失败(抽奖过程异常) uId：{} treeId：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span>drawProcessResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> drawProcessResult<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. 数据转换</span>
        <span class="token class-name">DrawAwardVO</span> drawAwardVO <span class="token operator">=</span> drawProcessResult<span class="token punctuation">.</span><span class="token function">getDrawAwardVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AwardDTO</span> awardDTO <span class="token operator">=</span> awardMapping<span class="token punctuation">.</span><span class="token function">sourceToTarget</span><span class="token punctuation">(</span>drawAwardVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        awardDTO<span class="token punctuation">.</span><span class="token function">setActivityId</span><span class="token punctuation">(</span>activityId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 封装数据</span>
        <span class="token class-name">DrawRes</span> drawRes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        drawRes<span class="token punctuation">.</span><span class="token function">setAwardDTO</span><span class="token punctuation">(</span>awardDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，完成 uId：{} treeId：{} drawRes：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>drawRes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> drawRes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;量化人群抽奖，失败 uId：{} treeId：{} reqJson：{}&quot;</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quantificationDrawReq<span class="token punctuation">.</span><span class="token function">getTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>quantificationDrawReq<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DrawRes</span><span class="token punctuation">(</span><span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Constants<span class="token punctuation">.</span>ResponseCode</span><span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/realpdai/tech-arch-doc/edit/master/md/project/lottery.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/4/24 20:24:59</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/md/project/yxdt.html" class="prev">
        易寻地图
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8f462fc4.js" defer></script><script src="/assets/js/2.7c7aaa4f.js" defer></script><script src="/assets/js/32.01010e94.js" defer></script>
  </body>
</html>
